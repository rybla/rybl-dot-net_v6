<!doctype html>
<html>
  <head>
    <title>rybl.net | Impe</title>

    <link rel="stylesheet" href="/style/common.css" />
    <!--<link rel="stylesheet" href="/style/skylighting-espresso.css" />-->
    <link rel="stylesheet" href="/style/skylighting-solarized.css" />
    <link rel="stylesheet" href="/style/background.css" />
    <link rel="stylesheet" href="/style/custom-elements.css" />
    <link rel="stylesheet" href="/style/header-and-footer.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap"
      rel="stylesheet"
    />
    <script
      id="MathJax-script"
      async
      src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"
    ></script>

    <script src="/script/parallax-body-background-on-scroll.js"></script>

    <!--<link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/tokyo-night-light.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>

    <script>
      hljs.highlightAll();
    </script>-->    <link rel="stylesheet" href="/style/post.css" />
  </head>
  <body>
    <svg>
      <defs>
        <filter
          id="dancing-stroke-svg-filter"
          color-interpolation-filters="linearRGB"
          filterUnits="objectBoundingBox"
          primitiveUnits="userSpaceOnUse"
        >
          <feMorphology
            operator="dilate"
            radius="4 4"
            in="SourceAlpha"
            result="morphology"
          />
          <feFlood flood-color="#30597E" flood-opacity="1" result="flood" />
          <feComposite
            in="flood"
            in2="morphology"
            operator="in"
            result="composite"
          />
          <feComposite
            in="composite"
            in2="SourceAlpha"
            operator="out"
            result="composite1"
          />
          <feTurbulence
            type="fractalNoise"
            baseFrequency="0.01 0.02"
            numOctaves="1"
            seed="0"
            stitchTiles="stitch"
            result="turbulence"
          />
          <feDisplacementMap
            in="composite1"
            in2="turbulence"
            scale="17"
            xChannelSelector="A"
            yChannelSelector="A"
            result="displacementMap"
          />
          <feMerge result="merge">
            <feMergeNode in="SourceGraphic" result="mergeNode" />
            <feMergeNode in="displacementMap" result="mergeNode1" />
          </feMerge>
        </filter>
      </defs>
    </svg>

    <div id="background"></div>
    <header><div class="title">
      <div class="root-title">
        <a href="/">rybl.net</a>
      </div>

      <img class="website-icon" src="/image/rybl-small.png" />

      <div class="local-title">Impe</div>
    </div>
    <div class="menu">
      <div class="item">
        <a href="/">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"
            stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-circle-slash-icon lucide-circle-slash">
            <circle cx="12" cy="12" r="10" />
            <line x1="9" x2="15" y1="15" y2="9" />
          </svg>
        </a>
      </div>
      <div class="item">
        <a href="/page/library.html">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"
            stroke-linecap="round" stroke-linejoin="round"
            class="icon lucide lucide-library-icon lucide-library">
            <path d="m16 6 4 14" />
            <path d="M12 6v14" />
            <path d="M8 8v12" />
            <path d="M4 4v16" />
          </svg>
        </a>
      </div>
      <div class="item">
        <a href="/page/about.html">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"
            stroke-linecap="round" stroke-linejoin="round"
            class="icon lucide lucide-info-icon lucide-info">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 16v-4" />
            <path d="M12 8h.01" />
          </svg>
        </a>
      </div>
      <div class="item">
        <a href="/page/profile.html">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"
            stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-globe-icon lucide-globe">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20" />
            <path d="M2 12h20" />
          </svg>
        </a>
      </div>
      <div class="item">
        <a href="/page/references-graph.html">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"
            stroke-linecap="round" stroke-linejoin="round"
            class="lucide lucide-orbit-icon lucide-orbit">
            <path d="M20.341 6.484A10 10 0 0 1 10.266 21.85" />
            <path d="M3.659 17.516A10 10 0 0 1 13.74 2.152" />
            <circle cx="12" cy="12" r="3" />
            <circle cx="19" cy="5" r="2" />
            <circle cx="5" cy="19" r="2" />
          </svg>
        </a>
      </div>
      <div class="item">
        <a href="/page/signature.html"><svg xmlns="http://www.w3.org/2000/svg"
            width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="1" stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-fingerprint-icon lucide-fingerprint">
            <path d="M12 10a2 2 0 0 0-2 2c0 1.02-.1 2.51-.26 4" />
            <path d="M14 13.12c0 2.38 0 6.38-1 8.88" />
            <path d="M17.29 21.02c.12-.6.43-2.3.5-3.02" />
            <path d="M2 12a10 10 0 0 1 18-6" />
            <path d="M2 16h.01" />
            <path d="M21.8 16c.2-2 .131-5.354 0-6" />
            <path d="M5 19.5C5.5 18 6 15 6 12a6 6 0 0 1 .34-2" />
            <path d="M8.65 22c.21-.66.45-1.32.57-2" />
            <path d="M9 6.8a6 6 0 0 1 9 5.2v2" />
          </svg></a>
      </div>
    </div></header>
    <main><h1><a href="/post/impe.html"
class="no-link-favicon no-link-preview">Impe</a></h1>
<div>
<div class="sidenote persistent header-info">
<p><u>Published:</u> 2021-03-15</p>
<p><u>Tags:</u> computics, Haskell</p>
<p><u>Abstract</u></p>
<p>This is a demonstration of the design and implementation of a very
simple imperative programming language, Impe, using Haskell. The goal is
to demonstrate the convenience and advanced features and libraries that
Haskell offers for programming language implementation.</p>
</div>
</div>
<div>
<div class="sidenote persistent table-of-contents">
<p><u>Table of Contents</u></p>
<ol type="1">
<li><a href="#introduction"
class="no-link-favicon no-link-preview">Introduction</a></li>
<li><a href="#design" class="no-link-favicon no-link-preview">Design</a>
<ol type="1">
<li><a href="#grammar"
class="no-link-favicon no-link-preview">Grammar</a></li>
<li><a href="#variables"
class="no-link-favicon no-link-preview">Variables</a></li>
<li><a href="#void-versus-unit"
class="no-link-favicon no-link-preview">Void versus Unit</a></li>
</ol></li>
<li><a href="#implementation"
class="no-link-favicon no-link-preview">Implementation</a>
<ol type="1">
<li><a href="#interpretation"
class="no-link-favicon no-link-preview">Interpretation</a>
<ol type="1">
<li><a href="#organization"
class="no-link-favicon no-link-preview">Organization</a></li>
</ol></li>
<li><a href="#grammar"
class="no-link-favicon no-link-preview">Grammar</a></li>
<li><a href="#effects"
class="no-link-favicon no-link-preview">Effects</a>
<ol type="1">
<li><a href="#logging"
class="no-link-favicon no-link-preview">Logging</a></li>
<li><a href="#excepting"
class="no-link-favicon no-link-preview">Excepting</a></li>
<li><a href="#statefulness"
class="no-link-favicon no-link-preview">Statefulness</a></li>
</ol></li>
<li><a href="#parsing"
class="no-link-favicon no-link-preview">Parsing</a>
<ol type="1">
<li><a href="#lexing-with-parsec"
class="no-link-favicon no-link-preview">Lexing with Parsec</a></li>
<li><a href="#parsing-with-parsec"
class="no-link-favicon no-link-preview">Parsing with Parsec</a>
<ol type="1">
<li><a href="#infixed-operators"
class="no-link-favicon no-link-preview">Infixed Operators</a></li>
</ol></li>
</ol></li>
<li><a href="#namespaces"
class="no-link-favicon no-link-preview">Namespaces</a></li>
<li><a href="#typechecking"
class="no-link-favicon no-link-preview">Typechecking</a></li>
<li><a href="#executing"
class="no-link-favicon no-link-preview">Executing</a></li>
<li><a href="#interpreting"
class="no-link-favicon no-link-preview">Interpreting</a></li>
<li><a href="#main" class="no-link-favicon no-link-preview">Main</a>
<ol type="1">
<li><a href="#command-line-options"
class="no-link-favicon no-link-preview">Command Line Options</a></li>
<li><a href="#interactive-repl"
class="no-link-favicon no-link-preview">Interactive REPL</a></li>
</ol></li>
</ol></li>
<li><a href="#conclusions"
class="no-link-favicon no-link-preview">Conclusions</a></li>
<li><a href="#references"
class="no-link-favicon no-link-preview">References</a></li>
<li><a href="#signature"
class="no-link-favicon no-link-preview">Signature</a></li>
</ol>
</div>
</div>
<h2 id="introduction">§ <a href="#introduction"
class="no-link-favicon no-link-preview">Introduction</a></h2>
<p>This post documents the design and implementation of an interpreter
for a very simple imperative programming lanugage, <em>Impe</em>, using
Haskell. The goal is to demonstrate the convenience and advanced
features and libraries that Haskell offers for programming language
implementation. All the code used and referenced in this post can be
found in this github repository: <span><span
class="sidenote preview">riib/impe<br/><em><a
href="https://github.com/rybla/impe" title="_blank"><img
src="/favicon/github.com.svg" class="favicon"
alt="/favicon/github.com.svg" />https://github.com/ucsd-progsys/liquidhaskell</a></em><br/>Placeholder
description for https://github.com/ucsd-progsys/liquidhaskell</span><a
href="https://github.com/rybla/impe"><img src="/favicon/github.com.svg"
class="favicon"
alt="/favicon/github.com.svg" />riib/impe</a></span>.</p>
<h2 id="design">§ <a href="#design"
class="no-link-favicon no-link-preview">Design</a></h2>
<h3 id="grammar">§ <a href="#grammar"
class="no-link-favicon no-link-preview">Grammar</a></h3>
<p>Grammar:</p>
<div class="todo">
<p>define what <code>...</code> means</p>
</div>
<div class="sourceCode" id="cb1"><pre
class="sourceCode txt"><code class="sourceCode default"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>&lt;program&gt;</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  ::= &lt;instruction&gt; ...</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>&lt;instruction&gt;</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  ::= { &lt;instruction&gt; ... }</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    | &lt;name&gt;: &lt;type&gt;;</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    | &lt;name&gt; &lt;- &lt;expression&gt;;</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    | &lt;name&gt;: &lt;type&gt; &lt;- expression;</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    | &lt;name&gt;(&lt;name&gt;: &lt;type&gt;, ...): &lt;type&gt; = &lt;instruction&gt;</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    | &lt;name&gt;(&lt;expression&gt;, ...);</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    | if &lt;expression&gt; then &lt;instruction&gt; else &lt;instruction&gt;</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    | while &lt;expression&gt; do &lt;instruction&gt;</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    | return &lt;expression&gt;;</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    | pass;</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>&lt;type&gt;</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  ::= void</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    | unit</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    | int</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    | bool</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    | string</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    | (&lt;type&gt;, ...) -&gt; &lt;type&gt;</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>&lt;expression&gt;</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  ::= unit</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    | &lt;bool&gt;</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    | &lt;int&gt;</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    | &lt;string&gt;</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    | &lt;name&gt;</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    | &lt;name&gt;(&lt;expression&gt;, ...)</span></code></pre></div>
<div class="todo">
<p><code>&lt;-</code> vs <code>=</code> syntax why initialization is a
seperate statement rather than syntax sugar where semicolons are
necessary and where not brief description of syntax features what are
procedure calls what are blocks and scopes how does <code>return</code>
work how does <code>pass</code> work, and is it different from
<code>{}</code></p>
</div>
<h3 id="variables">§ <a href="#variables"
class="no-link-favicon no-link-preview">Variables</a></h3>
<p>Variables are <em>mutable</em> -- the value of a variable can be
changed during the program's execution. An analogy: a variable is like a
box that can have its contents replaced while still staying the same box
(in the same place i.e. memory).</p>
<p>Variables are <em>call by value</em> -- when a variable is mentioned
(as an argument to a function call), it is immediately evaluated. This
is opposed to <em>call by name</em> where an argument variable is passed
by name and is then evaluated when it is needed in the function's
execution.</p>
<div class="todo">
<p>citations to sources that explain this tangent about Haskell's
laziness</p>
</div>
<h3 id="void-versus-unit">§ <a href="#void-versus-unit"
class="no-link-favicon no-link-preview">Void versus Unit</a></h3>
<p>Typically when you want to ignore the output of a function, you can
do just that without a second thought. But in this design, you must be
conscious of it. The syntax for calling a procedure will be typechecked
to require that the return type is in fact <code>void</code>. Many
languages opt to use the <code>unit</code> type to reflect a trivial
value, and this is fine. But <code>void</code> allows the power of a
native requirement that the return value of a function <em>cannot</em>
be useful. So perhaps eliminates some bugs.</p>
<p>Additionally, <code>void</code>-return-typed functions cannot be
well-typed in expressions, since no function can have a
<code>void</code> parameter and there is no term of type
<code>void</code>.</p>
<p>The type <code>void</code> encodes a type "with no values". In a more
standard type system, it should be impossible to have a function with
the type <code>a -&gt; void</code> for some type <code>a</code>, because
then the function produces a value of a type with no values! But in
Impe, <code>void</code> is interpreted to mean a type with values that
are inaccessible. So, Impe's typing rules ensure that a function that
returns <code>void</code> is never used somewhere where a value is
expected, and a value is never used where <code>void</code> is
expected.</p>
<p>It would be possible to use <code>unit</code> in place of void, and
the just have the programmer ignore the output of functions that return
<code>unit</code> as it is trivial (this is how Haskell handles this,
for example). But I liked the idea of using <code>void</code> in this
way since I haven't seen it enforced like this in many other languages,
but I makes for a useful little extra check that functions with outputs
that shouldn't be used do in fact don't have their output used (even
trivially).</p>
<div class="todo">
<p>should the only way to ignore output of function be to do this? or
should there be special syntax</p>
</div>
<p>To ignore output of a non-<code>void</code>-returning function
without cluttering namespace, you can do</p>
<pre class="plain"><code>{ _: t &lt;- f(e, ...); }</code></pre>
<p>where <code>t</code> is the return type of function
<code>f</code>.</p>
<h2 id="implementation">§ <a href="#implementation"
class="no-link-favicon no-link-preview">Implementation</a></h2>
<h3 id="interpretation">§ <a href="#interpretation"
class="no-link-favicon no-link-preview">Interpretation</a></h3>
<p>To interpret some given source code, there are three stages:</p>
<ol>
<li><em>Parsing</em>: takes source code as input, gives an AST of the
source code's program as output.</li>
<li><em>Typechecking</em>: takes a program AST as input, checkes that
the program is well-typed and gives the resulting typechecking context
as output.</li>
<li><em>Executing</em>: takes a program AST as input, executes the
program and gives the resulting execution context as output.</li>
</ol>
<h4 id="organization">§ <a href="#organization"
class="no-link-favicon no-link-preview">Organization</a></h4>
<p>The <code>Language.Impe</code> modules contains a collection of
submodules that define how the Impe programming language interprets Impe
source code. For each of the three stages of interpretation, there is a
corresponding independent module that does not import the module of any
other stage of interpretation:</p>
<ul>
<li><code>Parsing</code>: parsing Impe source code into an Impe
program</li>
<li><code>Typechecking</code>: checking that an Impe program is
well-typed</li>
<li><code>Executing</code>: executing an Impe program's instructions
imperatively</li>
</ul>
<p>There are a few functionalities that are shared between each of these
stages. As the prime example, Impe's grammatical structure must be
referencable in all three stages in order for <code>Parsing</code> to
build, <code>Typechecking</code> to inspect, and
<code>Executing</code>to traverse Impe programs. So, there is a common
module <code>Grammar</code> that is imported by all of them.</p>
<ul>
<li><code>Grammar</code>: grammatical structure of an Impe program</li>
</ul>
<p>Additionally, the other functionalities used during interpretation
are <em>logging</em> and <em>excepting</em>.</p>
<ul>
<li><code>Logging</code>: log messages concurrently with
computation</li>
<li><code>Excepting</code>: throw exception during computation</li>
</ul>
<p>Finally, to run an entire interpretation from source code to
execution result, a module that exports an <code>interpretProgram</code>
function is defined for convenience:</p>
<ul>
<li><code>Interpretation</code>: interpret an Impe program (from source
code to execution result)</li>
</ul>
<h3 id="grammar">§ <a href="#grammar"
class="no-link-favicon no-link-preview">Grammar</a></h3>
<p><code>Language.Impe.Grammar</code></p>
<p>The grammar given in the <em>Design</em> section was written in a
formal notation for reading ease and concision. The following code block
exhibits how the same grammar is defined in Haskell using algebraic data
types (ADTs).</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Program</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">Program</span> [<span class="dt">Instruction</span>]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Instruction</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">Block</span> [<span class="dt">Instruction</span>]</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Declaration</span> <span class="dt">Name</span> <span class="dt">Type</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Assignment</span> <span class="dt">Name</span> <span class="dt">Expression</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Initialization</span> <span class="dt">Name</span> <span class="dt">Type</span> <span class="dt">Expression</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Function</span> <span class="dt">Name</span> [(<span class="dt">Name</span>, <span class="dt">Type</span>)] <span class="dt">Type</span> <span class="dt">Instruction</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Branch</span> <span class="dt">Expression</span> <span class="dt">Instruction</span> <span class="dt">Instruction</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Loop</span> <span class="dt">Expression</span> <span class="dt">Instruction</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Return</span> <span class="dt">Expression</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">ProcedureCall</span> <span class="dt">Name</span> [<span class="dt">Expression</span>]</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Pass</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Type</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">VoidType</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">UnitType</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">IntType</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">BoolType</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">StringType</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">FunctionType</span> [<span class="dt">Type</span>] <span class="dt">Type</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Expression</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">Unit</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Bool</span> <span class="dt">Bool</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Int</span> <span class="dt">Int</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">String</span> <span class="dt">String</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Variable</span> <span class="dt">Name</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Application</span> <span class="dt">Name</span> [<span class="dt">Expression</span>]</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Name</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">Name</span> <span class="dt">String</span></span></code></pre></div>
<p>The <code>Grammar</code> module also defines for this data
<code>Show</code> instances that map each grammar term to the source
code that it would be parsed from.</p>
<h3 id="effects">§ <a href="#effects"
class="no-link-favicon no-link-preview">Effects</a></h3>
<p>TODO: rewrite this... how much detail do I want to give? TODO: talk
about handling effects</p>
<p>Effects -- such as statefulness, logging, excepting, and IO -- are
aggregated and ordered implicitly via Polysemy. All that's needed is
notify Polysemy to do this is to use the <code>Member</code> typeclass
constraint on the effect row of our <code>Sem</code> functions that use
the effect. For example, if <code>f</code>uses the statefulness effect,
<code>State</code>, with state <code>Int</code> and output
<code>Bool</code>, it is type-annotate as follows:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ot">f ::</span> <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Int</span>) r <span class="ot">=&gt;</span> <span class="dt">Sem</span> r <span class="dt">Bool</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>f <span class="ot">=</span> (<span class="dv">0</span> <span class="op">==</span>) <span class="op">.</span> (<span class="ot">`mod`</span> <span class="dv">3</span>) <span class="op">&lt;$&gt;</span> get</span></code></pre></div>
<p>Additionally, <code>Sem r</code> is a monad, so there exists a
convenient syntax and convention for handling such monadic computations
e.g.</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ot">g ::</span> <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Int</span>) r <span class="ot">=&gt;</span> <span class="dt">Sem</span> r <span class="dt">Bool</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>g <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">&lt;-</span> f</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  modify (<span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">&lt;-</span> f</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="op">$</span> a <span class="op">&amp;&amp;</span> b</span></code></pre></div>
<p>The great power of Polysemy, however, comes into play when a single
function performs multiple effects. Consider the following function that
performs the <code>State</code>, <code>Reader</code>, and
<code>Writer</code> effects:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode txt"><code class="sourceCode default"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>h ::</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  ( Member (State Int) r,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    Member (Reader Int) r,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    Member (Writer Bool) r</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  ) =&gt; Sem r ()</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>h = do</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  x &lt;- get</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  y &lt;- ask</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  tell $ x == y</span></code></pre></div>
<h4 id="logging">§ <a href="#logging"
class="no-link-favicon no-link-preview">Logging</a></h4>
<p><code>Language.Impe.Logging</code></p>
<p>The idea behind logging is to produce little messages that give some
insight into what the Haskell program is doing at different points of
evaluation. Each message is tagged with a <em>tag</em> corresponding to
what kind of information it is (e.g. debug, warning, or output).</p>
<p>Logs don't need to be very structured, since they are mostly useful
as a little ad-hoc. So a log consists of just a <em>tag</em> and a
message:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Log</span> <span class="ot">=</span> <span class="dt">Log</span> <span class="dt">Tag</span> <span class="dt">String</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Tag</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">Tag_Debug</span> <span class="co">-- only debugging</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Tag_Warning</span> <span class="co">-- non-breaking warnings for user</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Tag_Output</span> <span class="co">-- messages for user</span></span></code></pre></div>
<p>Polysemy provides a useful effect called <em>output</em> that is very
similar to the <em>writer</em> effect, except is it specialized for
writing lists of outputs that aren't to be interacted with inside within
an output-performing computation (whereas the writer effect provides
<em>listen</em> and <em>pass</em> actions in addition to <em>tell</em>;
see <span><span class="sidenote preview">Polysemy.Output<br/><em><a
href="https://hackage.haskell.org/package/polysemy-1.4.0.0/docs/Polysemy-Output.html"
title="_blank"><img src="/missing.ico" class="favicon"
alt="/missing.ico" />https://hackage.haskell.org/package/polysemy-1.4.0.0/docs/Polysemy-Output.html</a></em><br/>Placeholder
description for
https://hackage.haskell.org/package/polysemy-1.4.0.0/docs/Polysemy-Output.html</span><a
href="https://hackage.haskell.org/package/polysemy-1.4.0.0/docs/Polysemy-Output.html"><img
src="/missing.ico" class="favicon"
alt="/missing.ico" />Polysemy.Output</a></span> and <span><span
class="sidenote preview">Polysemy.Writer<br/><em><a
href="https://hackage.haskell.org/package/polysemy-1.4.0.0/docs/Polysemy-Writer.html"
title="_blank"><img src="/missing.ico" class="favicon"
alt="/missing.ico" />https://hackage.haskell.org/package/polysemy-1.4.0.0/docs/Polysemy-Output.html</a></em><br/>Placeholder
description for
https://hackage.haskell.org/package/polysemy-1.4.0.0/docs/Polysemy-Output.html</span><a
href="https://hackage.haskell.org/package/polysemy-1.4.0.0/docs/Polysemy-Writer.html"><img
src="/missing.ico" class="favicon"
alt="/missing.ico" />Polysemy.Writer</a></span> for details). Actually
handling the logging effect will be done later on in the <em>Main</em>
section, since for the most part logging is handled by IO.</p>
<h4 id="excepting">§ <a href="#excepting"
class="no-link-favicon no-link-preview">Excepting</a></h4>
<p><code>Language.Impe.Excepting</code></p>
<p>The idea behind excepting is to allow a computation to "escape" its
normal control flow part-way through. In basic Haskell, this is usually
modeling using the <code>Maybe</code> (or <code>Either</code> monad. As
a simple example:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- x / y + z</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ot">divide_then_add ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Int</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>divide_then_add x y z <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> divide x y</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (w <span class="op">+</span> z)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- x / y</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="ot">divide ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Int</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>divide x y</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> y <span class="op">==</span> <span class="dv">0</span> <span class="ot">-&gt;</span> <span class="dt">Nothing</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">-&gt;</span> <span class="fu">return</span> (x <span class="op">/</span> y)</span></code></pre></div>
<p>The function <code>divide</code> has a <em>exception</em> case that
evaluates to <code>Nothing</code>, and a <em>success</em> case which
evaluates to <code>return ...</code> where <code>return = Just</code>
the <code>Monad Maybe</code> instance.</p>
<p>Note that the desugaring of the <code>do</code> in
<code>divide_then_add</code> is</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- x / y + z</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ot">divide_then_add ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Int</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>divide_then_add x y z <span class="ot">=</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  divide x y <span class="op">&gt;&gt;=</span> \w <span class="ot">-&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (w <span class="op">+</span> z)</span></code></pre></div>
<p>In <code>divide_then_add</code>, the <code>Monad Maybe</code>
instance provides the monadic bind function <code>(&gt;&gt;=)</code>
exposed by desugaring of <code>do</code>. It's implemented as
follows:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ot">(&gt;&gt;=) ::</span> <span class="dt">Maybe</span> a <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> b) <span class="ot">-&gt;</span> <span class="dt">Maybe</span> b</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Just</span> x <span class="op">&gt;&gt;=</span> k <span class="ot">=</span> k x</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="dt">Nothing</span> <span class="op">&gt;&gt;=</span> _ <span class="ot">=</span> <span class="dt">Nothing</span></span></code></pre></div>
<p>So if <code>divide_then_add 1 0 1</code> is evaluated:</p>
<ul>
<li>in <code>divide 1 0 &gt;&gt;= ...</code>, <code>divide 1 0</code>
excepts</li>
<li>the second case of <code>(&gt;&gt;=)</code> is matched</li>
<li><code>divide_then_add 1 0 1</code> evaluates to
<code>Nothing</code></li>
</ul>
<p>This behavior effectively models the way an exception "escapes" the
control flow, since the second case of <code>(&gt;&gt;=)</code>
immediately finishes computation by ignoring the rest of the computation
(the <em>continuation</em> <code>k</code>) and evaluating to
<code>Nothing</code>.</p>
<p><code>Maybe</code> is the very simplest way to model excepting. A
slightly more sophisticated way is to use <code>Either e</code> where
<code>e</code> is the type of data an exception contains (whereas
<code>Maybe</code> doesn't allow an exception to contain any data).</p>
<p>Polysemy provides an effect called <em>Error</em> which works just
like <code>Either e</code> in the Polysemy framework. Using it's data
type, <code>Error e</code>, the functions <code>divide_then_add</code>
and <code>divide</code> can be rewritten as follows, with exception data
of of type <code>String</code>:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- x / y + z</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ot">divide_then_add ::</span> <span class="dt">Member</span> (<span class="dt">Error</span> <span class="dt">String</span>) r <span class="ot">=&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Sem</span> r <span class="dt">Int</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>divide_then_add x y z <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> divide x y</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (w <span class="op">+</span> z)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- x / y</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="ot">divide ::</span> <span class="dt">Member</span> (<span class="dt">Error</span> <span class="dt">String</span>) r <span class="ot">=&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Sem</span> r <span class="dt">Int</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>divide x y</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> y <span class="op">==</span> <span class="dv">0</span> <span class="ot">-&gt;</span> throwError <span class="op">$</span> printf <span class="st">&quot;attempting to divide `%s`by `0`&quot;</span> (<span class="fu">show</span> x)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">-&gt;</span> <span class="fu">return</span> (x <span class="op">/</span> y)</span></code></pre></div>
<p>where Polysemy exposes the function</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ot">throwError ::</span> <span class="dt">Member</span> (<span class="dt">Error</span> e) r <span class="ot">=&gt;</span> e <span class="ot">-&gt;</span> <span class="dt">Sem</span> r a</span></code></pre></div>
<p>A main difference between Polysemy's <code>Error</code> and the more
basic <code>Maybe</code> or <code>Either</code> is that a computation of
type <code>Member (Error e) r =&gt; Sem r a</code> can't be directly
inspected (i.e. pattern-matched on) to see whether it contains an
exception or a success. Instead, Polysemy provides the handler</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ot">runError ::</span> <span class="dt">Sem</span> (<span class="dt">Error</span> e <span class="op">:</span> r) a <span class="ot">-&gt;</span> <span class="dt">Sem</span> r (<span class="dt">Either</span> e a)</span></code></pre></div>
<p>to inspect the error status of a computation, where the effect row is
headed by an <code>Error</code> effect. Since the error has been handled
into <code>Either e a</code>, the error effect is safely removed from
the head of the effect row.</p>
<p>TODO: by default, each stage of interpretation will use the
<em>logging</em> and <em>exepting</em> effects.</p>
<h4 id="statefulness">§ <a href="#statefulness"
class="no-link-favicon no-link-preview">Statefulness</a></h4>
<p>TODO: how <code>State s</code> works TODO: pattern of describing
state data type, and using lens fields that generate lenses using
<code>makeLenses</code> via Templatehaskell</p>
<h3 id="parsing">§ <a href="#parsing"
class="no-link-favicon no-link-preview">Parsing</a></h3>
<p>Parsing is the process of reading some input source code and yielding
a program constructed by the program's language's grammar. The
<span><span class="sidenote preview">Parsec<br/><em><a
href="https://hackage.haskell.org/package/parsec" title="_blank"><img
src="/missing.ico" class="favicon"
alt="/missing.ico" />https://hackage.haskell.org/package/polysemy-1.4.0.0/docs/Polysemy-Output.html</a></em><br/>Placeholder
description for
https://hackage.haskell.org/package/polysemy-1.4.0.0/docs/Polysemy-Output.html</span><a
href="https://hackage.haskell.org/package/parsec"><img
src="/missing.ico" class="favicon"
alt="/missing.ico" />Parsec</a></span> package provides a convenient
framework for doing parsing using <em>monadic parsing combinators</em>.
Read the details of the package to learn exactly how such combinators
are implemented, but here will focus just on how to use them to write
Impe's parser.</p>
<p>Parsec breaks up parsing into two stages: defining a <em>lexer</em>,
and defining the parsers for each grammatical structure. The lexer can
be configured and generates some useful parsers that can recognize what
counts as whitespace, identifiers, string literals, etc. The
programmer-defined parsers are build from the generated parsers.</p>
<h4 id="lexing-with-parsec">§ <a href="#lexing-with-parsec"
class="no-link-favicon no-link-preview">Lexing with Parsec</a></h4>
<p><code>Language.Impe.Lexing</code></p>
<p>The Impe lexer (or as Parsec calls it, a <em>tokenParser</em>) is
defined as follows:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">LexStream</span> <span class="ot">=</span> <span class="dt">String</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">LexState</span> <span class="ot">=</span> ()</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">LexMonad</span> <span class="ot">=</span> <span class="dt">Identity</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="ot">languageDef ::</span> <span class="dt">GenLanguageDef</span> <span class="dt">LexStream</span> <span class="dt">LexState</span> <span class="dt">LexMonad</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>languageDef <span class="ot">=</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  emptyDef</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    { commentStart <span class="ot">=</span> <span class="st">&quot;/*&quot;</span>,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>      commentEnd <span class="ot">=</span> <span class="st">&quot;*/&quot;</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>      commentLine <span class="ot">=</span> <span class="st">&quot;//&quot;</span>,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>      identStart <span class="ot">=</span> letter,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>      identLetter <span class="ot">=</span> alphaNum <span class="op">&lt;|&gt;</span> oneOf [<span class="ch">&#39;_&#39;</span>],</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>      reservedNames <span class="ot">=</span> [<span class="st">&quot;while&quot;</span>, <span class="st">&quot;do&quot;</span>, <span class="st">&quot;if&quot;</span>, <span class="st">&quot;then&quot;</span>, <span class="st">&quot;else&quot;</span>, <span class="st">&quot;return&quot;</span>, <span class="st">&quot;pass&quot;</span>],</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>      reservedOpNames <span class="ot">=</span> [<span class="st">&quot;&lt;-&quot;</span>, <span class="st">&quot;&amp;&amp;&quot;</span>, <span class="st">&quot;||&quot;</span>, <span class="st">&quot;~&quot;</span>, <span class="st">&quot;+&quot;</span>, <span class="st">&quot;-&quot;</span>, <span class="st">&quot;*&quot;</span>, <span class="st">&quot;/&quot;</span>, <span class="st">&quot;^&quot;</span>, <span class="st">&quot;%&quot;</span>, <span class="st">&quot;=&quot;</span>, <span class="st">&quot;&gt;&quot;</span>, <span class="st">&quot;&gt;=&quot;</span>, <span class="st">&quot;&lt;&quot;</span>, <span class="st">&quot;&lt;=&quot;</span>, <span class="st">&quot;&lt;&gt;&quot;</span>],</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>      caseSensitive <span class="ot">=</span> <span class="dt">True</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="ot">tokenParser ::</span> <span class="dt">TokenParser</span> <span class="dt">LexState</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>tokenParser <span class="ot">=</span> makeTokenParser languageDef</span></code></pre></div>
<p>The type <code>LexStream</code> indicates that the input stream to
parse is a <code>String</code>. The type <code>LexState</code> indicates
that parsing uses the trivial state <code>()</code>. The type
<code>LexMonad</code> indicates that parsing is done within the
<code>Identity</code>monad.</p>
<p>The <code>languageDef</code> specifications are:</p>
<ul>
<li><code>commentStart</code>: the string "/*" starts a block
comment</li>
<li><code>commentEnd</code>: the string "*/" ends a block comment</li>
<li><code>commentLine</code>: the string "//" starts a line comment</li>
<li><code>identStart</code>: an identifier must start with a letter
character</li>
<li><code>identLetter</code>: an identifier's non-starting characters
must be letters, numbers, or '_'</li>
<li><code>reservedNames</code>: these names are reserved (i.e. cannot be
identifiers)</li>
<li><code>reservedOpNames</code>: these operators are reserved (i.e.
cannot be used in identifiers)</li>
<li><code>caseSensitive</code>: this language is case-sensitive</li>
</ul>
<p>The <code>tokenParser</code> is a <code>TokenParser</code> produced
by <code>languageDef</code>. It provides a variety of useful parsers,
such as</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode txt"><code class="sourceCode default"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>identifier :: Parser String</span></code></pre></div>
<p>which is a <code>Parser</code> that parses the next identifier (which
is of type <code>String</code>).</p>
<h4 id="parsing-with-parsec">§ <a href="#parsing-with-parsec"
class="no-link-favicon no-link-preview">Parsing with Parsec</a></h4>
<p><code>Language.Impe.Parsing</code></p>
<p>Now that the lexer is defined, the atomic parsers such as
<code>identifier</code> can be built up to define parsers for each of
Impe's grammatica constructs.</p>
<p>First,</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ot">program ::</span> <span class="dt">Parser</span> <span class="dt">Program</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>program <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  insts <span class="ot">&lt;-</span> many instruction</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  eof</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="op">$</span> <span class="dt">Program</span> insts</span></code></pre></div>
<p>is a <code>Parser</code> that parses a complete program. Here,
<code>many</code> is a parser combinator (provided by Parsec) that
parses any number (including 0) of whatever <code>instruction</code>
parses, consecutively as a list. Then <code>instruction</code> is
defined as</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ot">instruction ::</span> <span class="dt">Parser</span> <span class="dt">Instruction</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>instruction <span class="ot">=</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  block</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;|&gt;</span> pass</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;|&gt;</span> return_</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;|&gt;</span> try function</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;|&gt;</span> branch</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;|&gt;</span> loop</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;|&gt;</span> try initialization</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;|&gt;</span> try declaration</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;|&gt;</span> try assignment</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;|&gt;</span> try procedureCall</span></code></pre></div>
<p>which makes use of a parser for each of the constructors of
<code>Instruction</code>. This also uses two new parser combinators:</p>
<ul>
<li><code>p1 &lt;|&gt; p2</code> does parser <code>p1</code>, but in the
case of a parsing failure, then does parser <code>p2</code>. Note that
if <code>p1</code> modified the parsing stream of state then that
modification is propogated into the parsing of <code>p2</code>.</li>
<li><code>try p</code> tries to do the parser <code>p</code>, but in the
case of a parsing failure, <code>try</code> ignores how <code>p</code>
may have modified the parsing stream or state and then continues.</li>
</ul>
<p>These combinators interact such that <code>try</code> needs to prefix
the parsers that might consume some of the parsing stream before
failing, and <code>try</code> doesn't need to prefix the parsers will
fail immediately before making any such modifications.</p>
<p>To demonstrate this behavior, consider the following parsers:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>ab <span class="ot">=</span> char <span class="ch">&#39;a&#39;</span> <span class="op">&gt;&gt;</span> char <span class="ch">&#39;b&#39;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>ac <span class="ot">=</span> char <span class="ch">&#39;a&#39;</span> <span class="op">&gt;&gt;</span> char <span class="ch">&#39;c&#39;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>ab_ac <span class="ot">=</span> ab <span class="op">&lt;|&gt;</span> ac</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>ab_ac&#39; <span class="ot">=</span> try ab <span class="op">&lt;|&gt;</span> ac</span></code></pre></div>
<p>Parsers <code>ab_ac</code> and <code>ab_ac'</code> are very similar
except that <code>ab_ac</code> does <code>ab</code> instead of
<code>try ab</code> as the first argument of <code>(&lt;|&gt;)</code>.
The goal is that <code>ab_ac</code> and <code>ab_ac'</code> should each
parse either the string "ab" or the string "ac". Here is how
<code>ab_ac</code> processes the string "ac":</p>
<table>
<thead>
<tr>
<th>#</th>
<th>stream</th>
<th>parsing</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>"ac"</td>
<td><code>ab &lt;\|&gt; ac</code> uses left arg: <code>ab</code></td>
</tr>
<tr>
<td>2</td>
<td>"ac" -&gt; "c"</td>
<td><code>ab</code> parses 'a'</td>
</tr>
<tr>
<td>3</td>
<td>"c"</td>
<td><code>ab</code> expects 'b' but sees 'c', so fails</td>
</tr>
<tr>
<td>4</td>
<td>"c"</td>
<td><code>ab &lt;\|&gt; ac</code> does right arg: <code>ac</code></td>
</tr>
<tr>
<td>5</td>
<td>"c"</td>
<td><code>ac</code> expects 'a' but sees 'c', so fails</td>
</tr>
</tbody>
</table>
<p>Here for <code>ab_ac</code>, in step 2, the 'a' in "ac" was parsed,
so by step 5 only the string "c" is left.</p>
<p>On the other hand, here is how <code>ab_ac'</code>processes the
string "ac":</p>
<table>
<thead>
<tr>
<th>#</th>
<th>stream</th>
<th>parsing</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>"ac"</td>
<td><code>try ab &lt;\|&gt; ac</code> does left arg:
<code>try ab</code></td>
</tr>
<tr>
<td>2</td>
<td>"ac"</td>
<td><code>try ab</code> caches current stream, then does
<code>ab</code></td>
</tr>
<tr>
<td>3</td>
<td>"ac" -&gt; "c"</td>
<td><code>ab</code>parses 'a'</td>
</tr>
<tr>
<td>4</td>
<td>"c"</td>
<td><code>ab</code>expects 'b' but sees 'c', so fails</td>
</tr>
<tr>
<td>5</td>
<td>"c" -&gt; "ac"</td>
<td><code>try ab</code> restores cached stream, and propogates
failure</td>
</tr>
<tr>
<td>6</td>
<td>"ac"</td>
<td><code>try ab &lt;\|&gt; ac</code> does right
argument:<code>ac</code></td>
</tr>
<tr>
<td>7</td>
<td>"ac" -&gt; "c"</td>
<td><code>char 'a'</code> parses 'a'</td>
</tr>
<tr>
<td>8</td>
<td>"c" -&gt; ""</td>
<td><code>char 'c'</code> parses 'c'</td>
</tr>
</tbody>
</table>
<p>Here for <code>ab_ac'</code>, the same first parse failure in
<code>ab_ac</code> before arises on step 4. However, since
<code>ab</code> was wrapped in a <code>try</code>, the 'a' parsed on
step 3 is restored on step 5 where <code>try ab</code> handles
<code>ab</code>'s failure by restoring the cache saved from step 2 and
propogating the failure.</p>
<p>This behavior of <code>try</code> manifests in the definition of
<code>instruction</code> where, for example, <code>initialization</code>
is wrapped in <code>try</code>. Here are the definitions of the
<code>initialization</code> and <code>declaration</code> parsers.</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- x : t &lt;- e;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="ot">initialization ::</span> <span class="dt">Parser</span> <span class="dt">Instruction</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>initialization <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> name</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  colon</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> type_</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  reservedOp <span class="st">&quot;&lt;-&quot;</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  e <span class="ot">&lt;-</span> expression</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  semi</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="op">$</span> <span class="dt">Initialization</span> x t e</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- x : t;</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="ot">declaration ::</span> <span class="dt">Parser</span> <span class="dt">Instruction</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>declaration <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> name</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  colon</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> type_</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>  semi</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="op">$</span> <span class="dt">Declaration</span> x t</span></code></pre></div>
<p>If <code>instruction</code> used merely <code>initialization</code>
rather than <code>try initialization</code>, then the string "b: bool;"
would be have "b", ":", and "bool" parsed from it by
<code>initialization</code>, and then a failure. Then when
<code>(&lt;|&gt;)</code> does its right argument, the input stream it
starts with is just ";" which will cause a parse error since nothing
parses just ";". This is incorrect because "b : bool;" should be parsed
successfully by <code>declaration</code>! The
<code>try initialization</code> makes sure that the "b : bool" is
restored back onto the stream before <code>(&lt;|&gt;)</code> does its
right argument.</p>
<p>And that's most of what there is to standard parsing with Parsec! The
only other major functions used here are these that deal with special
strings and symbols:</p>
<ul>
<li><code>reserved :: String -&gt; Parser String</code> -- given a
reserved name (string) <code>rn</code>, parses <code>rn</code> from the
stream</li>
<li><code>reservedOp :: String -&gt; Parser String</code> -- given a
reserved operator name (string) <code>ro</code>, parses <code>ro</code>
from the stream</li>
<li><code>symbol :: String -&gt; Parser String</code> -- given any
symbol (string) <code>sym</code>, parses <code>sym</code> from the
stream</li>
<li><code>identifier :: Parser String</code> -- parses an identifier
(string) from the stream, where the characters allowed to start and be
contained in an identifier are defined in the Impe lexer</li>
</ul>
<h5 id="infixed-operators">§ <a href="#infixed-operators"
class="no-link-favicon no-link-preview">Infixed Operators</a></h5>
<p>Parsec offers a conventient little system for setting up the parsing
of infixed operators (unary and binary) with specified <em>infixity
levels</em> and <em>associative handedness</em> (left or right).</p>
<ul>
<li><em>infixity levels</em> define how "tightly" different infixed
operators should be parsed e.g. the difference between parsing "a + b _
c" as "(a + b) _ c" and "a + (b * c)"</li>
<li><em>associative handedness</em> defines which direction (left or
right) several operators of the same infixity level should be parsed
e.g. the difference between parsing "a + b + c + d" as "a + (b + (c +
d))" and "((a + b) + c) + d" (this does not apply to unary
operators)</li>
</ul>
<p>Here is the definition of the <code>expression</code> parser for
Impe, relies on Parsec's <code>buildExpressionParser</code>:</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ot">expression ::</span> <span class="dt">Parser</span> <span class="dt">Expression</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>expression <span class="ot">=</span> buildExpressionParser ops expression&#39;</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    ops <span class="ot">=</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>      [ [ binaryOp <span class="st">&quot;^&quot;</span> <span class="dt">AssocLeft</span> ],</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        [ binaryOp <span class="st">&quot;*&quot;</span> <span class="dt">AssocLeft</span>, binaryOp <span class="st">&quot;/&quot;</span> <span class="dt">AssocLeft</span> ],</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        [ binaryOp <span class="st">&quot;+&quot;</span> <span class="dt">AssocLeft</span>, binaryOp <span class="st">&quot;-&quot;</span> <span class="dt">AssocLeft</span> ],</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>        [ binaryOp <span class="st">&quot;%&quot;</span> <span class="dt">AssocLeft</span> ],</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>        [ binaryOp <span class="st">&quot;&lt;=&quot;</span> <span class="dt">AssocLeft</span>, binaryOp <span class="st">&quot;&lt;&quot;</span> <span class="dt">AssocLeft</span>, binaryOp <span class="st">&quot;&gt;=&quot;</span> <span class="dt">AssocLeft</span>, binaryOp <span class="st">&quot;&gt;&quot;</span> <span class="dt">AssocLeft</span> ],</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        [ binaryOp <span class="st">&quot;=&quot;</span> <span class="dt">AssocLeft</span> ],</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        [ unaryOp <span class="st">&quot;~&quot;</span> ],</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>        [ binaryOp <span class="st">&quot;&amp;&amp;&quot;</span> <span class="dt">AssocLeft</span>, binaryOp <span class="st">&quot;||&quot;</span> <span class="dt">AssocLeft</span> ],</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        [ binaryOp <span class="st">&quot;&lt;&gt;&quot;</span> <span class="dt">AssocLeft</span> ]</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    unaryOp opName <span class="ot">=</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Prefix</span> <span class="kw">do</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>        reservedOp opName</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span> \a <span class="ot">-&gt;</span> <span class="dt">Application</span> (<span class="dt">Name</span> opName) [a]</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    binaryOp opName assocHand <span class="ot">=</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">flip</span> <span class="dt">Infix</span> assocHand <span class="kw">do</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>        reservedOp opName</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span> \a b <span class="ot">-&gt;</span> <span class="dt">Application</span> (<span class="dt">Name</span> opName) [a, b]</span></code></pre></div>
<p>The local variable <code>ops</code> defines an
<code>OperatorTable</code> which is a list of lists of
<code>Operator</code>s. Each list in the table defines an infixity
level, in order from highest to lowest tightness. Each
<code>Operator</code> in each infixity level encodes a either a parser
for the operator and whether it is <code>Prefix</code>ed or
<code>Infixe</code>ed. The local functions <code>unaryOp</code> and
<code>binaryOp</code> abstract this structure, which depends only on the
operator name and associative handedness (which is left as a curried
argument of <code>binaryOp</code>).</p>
<ul>
<li><p>In <code>unaryOp</code>, the operator parser first parses the
prefixed operator, and then returns a parsing computation, of type
<code>Parser (Expression -&gt; Expression)</code>, that takes the parsed
argument of the operator and returns the grammatical structure for
applying the operator to that argument.</p></li>
<li><p>In <code>binaryOp</code>, the operator parser first parses the
infixed operator, and the nreturns a parsing computation, of type
<code>Parser (Expression -&gt; Expression -&gt; Expression)</code>, that
takes the two parsed arguments of the operator and returns the
grammatical structure for applying the operator to those
arguments.</p></li>
</ul>
<p>Finally, <code>buildExpressionParser</code> takes
<code>expression'</code> as an argument, which is the parser for
non-operator-application expressions. These are the expressions that the
built expression parser parses to give as arguments to the parsers
yielded by <code>unaryOp</code> and <code>binaryOp</code>. The parser
<code>expression'</code> is defined, in the same general form as
<code>instruction</code> as follows:</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ot">expression&#39; ::</span> <span class="dt">Parser</span> <span class="dt">Expression</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>expression&#39; <span class="ot">=</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  parens expression</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;|&gt;</span> try unit</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;|&gt;</span> try bool</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;|&gt;</span> try int</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;|&gt;</span> try string</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;|&gt;</span> try application</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;|&gt;</span> try variable</span></code></pre></div>
<p>where <code>unit</code>, <code>bool</code>, etc. are parsers for each
of those kinds of expressions.</p>
<h3 id="namespaces">§ <a href="#namespaces"
class="no-link-favicon no-link-preview">Namespaces</a></h3>
<p>TODO: describe goals, description of impl, and main interface</p>
<h3 id="typechecking">§ <a href="#typechecking"
class="no-link-favicon no-link-preview">Typechecking</a></h3>
<p><code>Language.Impe.Typechecking</code></p>
<p>Typechecking is the process of checking that program is
<em>well-typed</em>, where a program is well-typed in Impe if the
following conditions are met:</p>
<ul>
<li>for each application <code>f(e[1], ..., e[n])</code>, where
<code>f : (a[1], ..., a[n]) -&gt; b</code>, the type of
<code>e[i]</code> <em>unifies</em> with type <code>a[i]</code>
<code>f : (a[1], ..., a[n]) -&gt; void</code>.</li>
<li>for each function definition with a non-<code>void</code> return
type, every internal branch of the function's body must have a
<code>return</code> instruction</li>
<li>for each function definition with a <code>void</code> return type,
every internal branch of the function's body must <em>not</em> have a
<code>return</code> instruction</li>
<li>for each procedure call <code>f(e[1], ..., e[n])</code>,
<code>f</code> has a type of the form</li>
</ul>
<p>More simply but in less detail, these requirements amount to:</p>
<ul>
<li>functions must be called on arguments of the appropriate types</li>
<li>non-<code>void</code>-returning functions must always
<code>return</code></li>
<li><code>void</code>-returning functions must never
<code>return</code></li>
<li>procedure calls must be with <code>void</code>-returning
functions</li>
</ul>
<p>Here, <em>unifies with</em> just means "syntactically equal".
However, this is true only contentiously for Impe since there are
neither first-class functions nor polymorphic types.</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ot">unifyTypes ::</span> <span class="dt">Type</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="ot">-&gt;</span> <span class="dt">Typecheck</span> r <span class="dt">Type</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>unifyTypes s t <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;unify types: %s ~ %s&quot;</span> (<span class="fu">show</span> s) (<span class="fu">show</span> t)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> s <span class="op">==</span> t</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">then</span> <span class="fu">return</span> s</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span> throw <span class="op">$</span> <span class="dt">Excepting.TypeIncompatibility</span> s t</span></code></pre></div>
<p>The method for typechecking a program according to these conditions
will mostly follow a method called <em>bi-directional typechecking</em>,
where typechecking is divided into two "directions":</p>
<ul>
<li><em>checking</em> that a given expression <code>e</code> has a type
that unifies with given type <code>t</code></li>
<li><em>synthesize</em> the type of a given expression
<code>e</code></li>
</ul>
<p>To check that an application <code>f(e[1], ..., e[n])</code> is
well-typed:</p>
<ol>
<li><em>synthesize</em> the type of <code>f</code>, yielding
<code>(a[1], ..., a[n]) -&gt; b</code></li>
<li><em>synthesize</em> the types of arguments
<code>e[1], ..., e[n]</code> to be types
<code>t[1], ..., t[n]</code></li>
<li><em>check</em> that, for each <em>i</em>, type <code>t[i]</code>
unifies with type <code>a[n]</code></li>
</ol>
<p>This typechecking algorithm relies on the <em>synthesize</em> and
<em>check</em> functionalities. An in particular, the
<em>synthesize</em> functionality must have access to some sort of
implicit <em>state</em> where typings are stored when they are functions
and variables are declared. The stateful effect provided by Polysemy's
is <code>State s</code>, where <code>s</code> is the type of the state
data. The effect <code>State s</code> comes along with a basic
interface, where <code>get</code> and <code>set</code> are defined using
internal Polysemy details that are omitted here.</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- returns the current state</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ot">get ::</span> <span class="dt">Member</span> (<span class="dt">State</span> s) r <span class="ot">=&gt;</span> <span class="dt">Sem</span> r s</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>get <span class="ot">=</span> _ <span class="co">-- internal Polysemy details</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- replaces the current state</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="ot">put ::</span> <span class="dt">Member</span> (<span class="dt">State</span> s) r <span class="ot">=&gt;</span> s <span class="ot">-&gt;</span> <span class="dt">Sem</span> r ()</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>put <span class="ot">=</span> _ <span class="co">--- internal Polysemy details</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- replaces the current state with its image under a function</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="ot">modify ::</span> <span class="dt">Member</span> (<span class="dt">State</span> s) r <span class="ot">=&gt;</span> (s <span class="ot">-&gt;</span> s) <span class="ot">-&gt;</span> <span class="dt">Sem</span> r ()</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>modify f <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  st <span class="ot">&lt;-</span> get</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  put (f st)</span></code></pre></div>
<p>The state type for typechecking, or <em>typechecking context</em>,
must store the types of variables and functions, and in some sort of
structure that reflects nested scoping -- a <em>namespace</em>. The
<code>Namespace</code> data typed defined previously will do. This is
all that is needed for the typechecking context.</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Context</span> <span class="ot">=</span> <span class="dt">Context</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  {<span class="ot"> _namespace ::</span> <span class="dt">Namespace</span> <span class="dt">Name</span> <span class="dt">Type</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="ot">emptyContext ::</span> <span class="dt">Context</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>emptyContext <span class="ot">=</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Context</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    { _namespace <span class="ot">=</span> <span class="fu">mempty</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>makeLenses &#39;<span class="dt">&#39;Context</span></span></code></pre></div>
<p>Additionally a convenient alias for <em>typechecking
computations</em> is defined below.</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Typecheck</span> r a <span class="ot">=</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  ( <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Context</span>) r,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">Error</span> <span class="dt">Excepting.Exception</span>) r,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">Output</span> <span class="dt">Log</span>) r</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">=&gt;</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Sem</span> r a</span></code></pre></div>
<p>The basic ways of interacting with the typechecking context are
<em>declaring</em> (setting) the type of a name, and <em>declaring</em>
(getting) the type of a name. The naming convention
<code>synthesize&lt;x&gt;</code> indicates that the function synthesizes
the type of grammatical data <code>&lt;x&gt;</code>.</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- gets the type of `n`</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="ot">synthesizeName ::</span> <span class="dt">Name</span> <span class="ot">-&gt;</span> <span class="dt">Typecheck</span> r <span class="dt">Type</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>synthesizeName n <span class="ot">=</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  gets (<span class="op">^.</span> namespace <span class="op">.</span> at n) <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> t <span class="ot">-&gt;</span> <span class="fu">return</span> t</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> throw <span class="op">$</span> <span class="dt">Excepting.UndeclaredVariable</span> n</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- sets the type of `n` to be `t`</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="ot">declareName ::</span> <span class="dt">Name</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="ot">-&gt;</span> <span class="dt">Typecheck</span> r ()</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>declareName n t <span class="ot">=</span> modify <span class="op">$</span> namespace <span class="op">%~</span> initialize n t</span></code></pre></div>
<p>So now, how is a program typechecked? There are three parts:</p>
<ol>
<li>typecheck the prelude, implicitly included before a program</li>
<li>typecheck the program's body -- its list of statements</li>
<li>typecheck the program's <code>main</code> function, if it has one,
to see that it has the expected type of a main function</li>
</ol>
<p>As a typechecking computation:</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ot">typecheckProgram ::</span> <span class="dt">Program</span> <span class="ot">-&gt;</span> <span class="dt">Typecheck</span> r ()</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>typecheckProgram <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Program</span> insts <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="st">&quot;typecheck program&quot;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    typecheckPrelude</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mapM_</span> (<span class="fu">flip</span> checkInstruction <span class="dt">VoidType</span>) insts</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    typecheckMain</span></code></pre></div>
<p>Typechecking the prelude is a simple as loading the type information
specified by the primitive functions in
<code>Language.Impe.Primitive</code>.</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ot">typecheckPrelude ::</span> <span class="dt">Typecheck</span> r ()</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>typecheckPrelude <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="st">&quot;typecheck prelude&quot;</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapM_</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    (\(f, ss, t) <span class="ot">-&gt;</span> declare f <span class="op">$</span> <span class="dt">FunctionType</span> ss t)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    primitive_functions</span></code></pre></div>
<p>Typechecking instructions is the most interesting. As used in
<code>typecheckProgram</code>, the function
<code>checkInstruction</code> is meant to take an instruction and a type
and then <em>check</em> that the instruction <em>synthesizes</em> to a
type unifies with the expected type. Using the bidirectional
typechecking philosophy, <code>checkInstruction</code> should look like
the following:</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ot">checkInstruction ::</span> <span class="dt">Instruction</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="ot">-&gt;</span> <span class="dt">Typecheck</span> r ()</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>checkInstruction inst t <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="st">&quot;check instruction&quot;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  t&#39; <span class="ot">&lt;-</span> synthesizeInstruction inst</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  void <span class="op">$</span> unifyTypes t t&#39;</span></code></pre></div>
<p>Synthesizing the type of an instruction is where the actual
inspection of data comes in. In short the strategy for
<code>synthesizeInstruction</code> is:</p>
<ul>
<li><code>Return e</code> synthesizes to
<code>synthesizeExpression e</code></li>
<li><code>Branch e inst1 inst2</code> synthesizes to the unification of
<code>synthesizeInstruction inst1</code> and
<code>synthesizeInstruction inst2</code></li>
<li><code>Loop e inst</code> synthesizes to
<code>synthesizeInstruction inst</code></li>
<li><code>Block insts</code> synthesizes to... hmmmm</li>
<li>other instructions synthesize to <code>VoidType</code></li>
</ul>
<p>Synthesizing blocks is a bit tricky because there are multiple
statements with synthesizable types -- how should those types be
combined into the whole block's type?</p>
<p>Define an <em>intermediate type</em> to be either a specified type or
unspecified, which corresponds to <code>Maybe Type</code> in haskell.
Intermediate types unify as follows:</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ot">unifyIntermediateTypes ::</span> <span class="dt">Maybe</span> <span class="dt">Type</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Type</span> <span class="ot">-&gt;</span> <span class="dt">Typecheck</span> r (<span class="dt">Maybe</span> <span class="dt">Type</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>unifyIntermediateTypes mb_t1 mb_t2 <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;unify intermediate types: %s ~ %s&quot;</span> (<span class="fu">show</span> mb_t1) (<span class="fu">show</span> mb_t2)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> (mb_t1, mb_t2) <span class="kw">of</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Nothing</span>, <span class="dt">Nothing</span>) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Nothing</span>, <span class="dt">Just</span> t) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">Just</span> t</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Just</span> s, <span class="dt">Nothing</span>) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">Just</span> s</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Just</span> s, <span class="dt">Just</span> t) <span class="ot">-&gt;</span> <span class="dt">Just</span> <span class="op">&lt;$&gt;</span> unifyTypes s t</span></code></pre></div>
<p>Then the <code>synthesizeInstruction</code> strategy for a block
is:</p>
<ol>
<li>fold over the block's statements, accumulating the block's type as a
intermediate type starting unspecified</li>
<li>for each fold iteration, unify the current statement's synthesized
intermediate type with the accululator intermediate type</li>
</ol>
<p>For this strategy, a function
<code>synthesizeInstructionStep :: Instruction -&gt; Typecheck r (Maybe Type)</code>
is needed to synthesize intermediate types. These intermediate types
indicate that they do not contribute to specifying what the return type
of a function should be if they appear in the body of a function. But,
as in the original strategy for <code>synthesizeInstruction</code>, the
instruction <code>Return expr</code> specifically does specify the
return type of a function.</p>
<p>One last thing before implementing <code>synthesizeInstruction</code>
is how to account for nested scopes. Some structures -- blocks,
functions, branches, loops, returns, and procedure calls -- generate a
local scope where local typings are not exported globally. Since
<code>_namespace</code> is a <code>Namespace</code>, it has an interface
for handling nested scopes. All that's needed is a way to interface with
the namespace local scoping operations at the <code>Typecheck</code>
computation level.</p>
<p>The following function <code>withLocalScope</code> does just this. It
takes a typechecking computation <code>tch</code> as input, and then
generates a local scope -- using namespace's
<code>enterLocalScope</code> and <code>leaveLocalScope</code> -- for
running the <code>tch</code>.</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ot">withLocalScope ::</span> <span class="dt">Typecheck</span> r a <span class="ot">-&gt;</span> <span class="dt">Typecheck</span> r a</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>withLocalScope tch <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;entering local scope&quot;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  modify <span class="op">$</span> namespace <span class="op">%~</span> enterLocalScope</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">&lt;-</span> tch</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;leaving local scope&quot;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  modify <span class="op">$</span> namespace <span class="op">%~</span> leaveLocalScope</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> a</span></code></pre></div>
<p>Finally, all the tools for implementing
<code>synthesizeInstruction</code> are available:</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ot">synthesizeInstruction ::</span> <span class="dt">Instruction</span> <span class="ot">-&gt;</span> <span class="dt">Typecheck</span> r <span class="dt">Type</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>synthesizeInstruction inst <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="st">&quot;synthesize instruction&quot;</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  synthesizeInstructionStep inst <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> t <span class="ot">-&gt;</span> <span class="fu">return</span> t</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="dt">VoidType</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="ot">synthesizeInstructionStep ::</span> <span class="dt">Instruction</span> <span class="ot">-&gt;</span> <span class="dt">Typecheck</span> r (<span class="dt">Maybe</span> <span class="dt">Type</span>)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>synthesizeInstructionStep inst_ <span class="ot">=</span> <span class="kw">case</span> inst_ <span class="kw">of</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Block</span> insts <span class="ot">-&gt;</span> withLocalScope <span class="kw">do</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="st">&quot;synthesize block&quot;</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    ts <span class="ot">&lt;-</span> <span class="fu">mapM</span> synthesizeInstructionStep insts</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    foldM unifyIntermediateTypes <span class="dt">Nothing</span> ts</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Declaration</span> x t <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;synthesize declaration: %s&quot;</span> (<span class="fu">show</span> inst_)</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    when (t <span class="op">==</span> <span class="dt">VoidType</span>) <span class="op">.</span> throw <span class="op">$</span> <span class="dt">Excepting.VariableVoid</span> x</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    declareName x t</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Assignment</span> x e <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;synthesize assignment: %s&quot;</span> (<span class="fu">show</span> inst_)</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>    t <span class="ot">&lt;-</span> synthesizeName x</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    t&#39; <span class="ot">&lt;-</span> synthesizeExpression e</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    void <span class="op">$</span> unifyTypes t t&#39;</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Initialization</span> x t e <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;synthesize initialization: %s&quot;</span> (<span class="fu">show</span> inst_)</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- declaration</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>    when (t <span class="op">==</span> <span class="dt">VoidType</span>) <span class="op">.</span> throw <span class="op">$</span> <span class="dt">Excepting.VariableVoid</span> x</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>    declareName x t</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- assignment</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>    t&#39; <span class="ot">&lt;-</span> synthesizeExpression e</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>    void <span class="op">$</span> unifyTypes t t&#39;</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Function</span> f prms t inst <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;synthesize function: %s&quot;</span> (<span class="fu">show</span> inst_)</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>    declareName f <span class="op">$</span> <span class="dt">FunctionType</span> (<span class="fu">snd</span> <span class="op">&lt;$&gt;</span> prms) t</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>    withLocalScope <span class="kw">do</span></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mapM_</span> (\(x, s) <span class="ot">-&gt;</span> declareName x s) prms</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>      checkInstruction inst t</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Branch</span> e inst1 inst2 <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;synthesize branch: %s&quot;</span> (<span class="fu">show</span> inst_)</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>    checkExpression e <span class="dt">BoolType</span></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>    mbt1 <span class="ot">&lt;-</span> withLocalScope <span class="op">$</span> synthesizeInstructionStep inst1</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>    mbt2 <span class="ot">&lt;-</span> withLocalScope <span class="op">$</span> synthesizeInstructionStep inst2</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>    unifyIntermediateTypes mbt1 mbt2</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Loop</span> e inst <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;synthesize loop: %s&quot;</span> (<span class="fu">show</span> inst_)</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>    checkExpression e <span class="dt">BoolType</span></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>    withLocalScope <span class="op">$</span> synthesizeInstructionStep inst</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Return</span> e <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;synthesize return: %s&quot;</span> (<span class="fu">show</span> inst_)</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> <span class="op">&lt;$&gt;</span> synthesizeExpression e</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ProcedureCall</span> f args <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;synthesize procedure call: %s&quot;</span> (<span class="fu">show</span> inst_)</span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>    synthesizeName f <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>      fType<span class="op">@</span>(<span class="dt">FunctionType</span> ss t) <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>        unless (<span class="fu">length</span> args <span class="op">==</span> <span class="fu">length</span> ss) <span class="op">.</span> throw <span class="op">$</span></span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Excepting.ApplicationArgumentsNumber</span> f fType (<span class="fu">length</span> ss) args</span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mapM_</span> (<span class="fu">uncurry</span> checkExpression) (<span class="fu">zip</span> args ss)</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span> t</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>      fType <span class="ot">-&gt;</span></span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>        throw <span class="op">$</span> <span class="dt">Excepting.ApplicationNonfunction</span> f fType args</span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Pass</span> <span class="ot">-&gt;</span></span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="dt">Nothing</span></span></code></pre></div>
<h3 id="executing">§ <a href="#executing"
class="no-link-favicon no-link-preview">Executing</a></h3>
<p><code>Language.Impe.Executing</code></p>
<p>The setup for starting to implement <em>execution</em> is very
similar to typechecking. There is a context that contains the
information that is passed along implicitly during execution. Instead of
type information, this context contains name bindings, as well a simple
interface of IO.</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Context</span> <span class="ot">=</span> <span class="dt">Context</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  {<span class="ot"> _namespace ::</span> <span class="dt">Namespace</span> <span class="dt">Name</span> <span class="dt">Entry</span>,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="ot">    _inputLines ::</span> [<span class="dt">String</span>],</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="ot">    _outputString ::</span> <span class="dt">String</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Entry</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">EntryValue</span> (<span class="dt">Maybe</span> <span class="dt">Value</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">EntryClosure</span> (<span class="dt">Maybe</span> <span class="dt">Closure</span>)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">EntryPrimitiveFunction</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>makeLenses &#39;<span class="dt">&#39;Context</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Execution</span> r a <span class="ot">=</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  ( <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Context</span>) r,</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">Error</span> <span class="dt">Excepting.Exception</span>) r,</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">Output</span> <span class="dt">Log</span>) r</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">=&gt;</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Sem</span> r a</span></code></pre></div>
<p>To execute a program:</p>
<ol>
<li>load in prelude-defined variables and functions</li>
<li>execute the program's statements</li>
<li>call the main function (if there is one)</li>
</ol>
<div class="sourceCode" id="cb34"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="ot">executeProgram ::</span> <span class="dt">Program</span> <span class="ot">-&gt;</span> <span class="dt">Execution</span> r ()</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>executeProgram <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Program</span> insts <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="st">&quot;execute program&quot;</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    executePrelude</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mapM_</span> executeInstruction insts</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    executeMain</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="ot">executePrelude ::</span> <span class="dt">Execution</span> r ()</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>executePrelude <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="st">&quot;execute prelude&quot;</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- primitive variables</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapM_</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    ( \(x, _, e) <span class="ot">-&gt;</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">do</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>          declareVariable x</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>          adjustVariable x <span class="op">=&lt;&lt;</span> evaluateExpression e</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    primitive_variables</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- primitive functions</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapM_</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    (\(f, _, _) <span class="ot">-&gt;</span> declarePrimitiveFunction f)</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    primitive_functions</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="ot">executeMain ::</span> <span class="dt">Execution</span> r ()</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>executeMain <span class="ot">=</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>  queryFunction&#39; mainName <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> _ <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="st">&quot;execute main&quot;</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>      void <span class="op">$</span> executeInstruction (<span class="dt">ProcedureCall</span> mainName [])</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">return</span> ()</span></code></pre></div>
<p>The main function needed to implement the above is the
<code>executeInstruction</code> which describes how to <em>execute</em>
a single instruction.</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ot">executeInstruction ::</span> <span class="dt">Instruction</span> <span class="ot">-&gt;</span> <span class="dt">Execution</span> r (<span class="dt">Maybe</span> <span class="dt">Value</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>executeInstruction inst_ <span class="ot">=</span> <span class="kw">case</span> inst_ <span class="kw">of</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Block</span> insts <span class="ot">-&gt;</span> withLocalScope <span class="kw">do</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="st">&quot;execute block start&quot;</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    mb_v <span class="ot">&lt;-</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>      foldM</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>        ( \mb_v inst <span class="ot">-&gt;</span> <span class="kw">case</span> mb_v <span class="kw">of</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Just</span> v <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> <span class="dt">Just</span> v</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> executeInstruction inst</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Nothing</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>        insts</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="st">&quot;execute block end&quot;</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> mb_v</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Declaration</span> x _ <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;execute declaration: %s&quot;</span> (<span class="fu">show</span> inst_)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    declareVariable x</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Assignment</span> x e <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;execute assignment: %s&quot;</span> (<span class="fu">show</span> inst_)</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    adjustVariable x <span class="op">=&lt;&lt;</span> evaluateExpression e</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Initialization</span> x _ e <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;execute initialization: %s&quot;</span> (<span class="fu">show</span> inst_)</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    declareVariable x <span class="co">-- declaration</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    adjustVariable x <span class="op">=&lt;&lt;</span> evaluateExpression e <span class="co">-- assignment</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Function</span> f params _ inst <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;execute function definition: %s&quot;</span> (<span class="fu">show</span> inst_)</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>    declareFunction f</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    adjustFunction f (<span class="fu">fst</span> <span class="op">&lt;$&gt;</span> params, inst)</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Branch</span> e inst1 inst2 <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;execute branch: %s&quot;</span> (<span class="fu">show</span> inst_)</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>    evaluateExpression e <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Bool</span> <span class="dt">True</span> <span class="ot">-&gt;</span> withLocalScope <span class="op">$</span> executeInstruction inst1</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Bool</span> <span class="dt">False</span> <span class="ot">-&gt;</span> withLocalScope <span class="op">$</span> executeInstruction inst2</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>      v <span class="ot">-&gt;</span> throw <span class="op">$</span> <span class="dt">Excepting.ValueMaltyped</span> e <span class="dt">BoolType</span> v</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Loop</span> e inst <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;execute loop: %s&quot;</span> (<span class="fu">show</span> inst_)</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>    evaluateExpression e <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Bool</span> <span class="dt">True</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>        <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;evaluate loop condition to true: %s&quot;</span> (<span class="fu">show</span> e)</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>        executeInstruction inst <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Just</span> v <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>            <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;execute loop iteration to return value: %s&quot;</span> (<span class="fu">show</span> v)</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span> <span class="op">$</span> <span class="dt">Just</span> v</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Nothing</span> <span class="ot">-&gt;</span></span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>            withLocalScope <span class="op">$</span> executeInstruction <span class="op">$</span> <span class="dt">Loop</span> e inst</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Bool</span> <span class="dt">False</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>        <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;evaluate loop condition to false: %s&quot;</span> (<span class="fu">show</span> e)</span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>      v <span class="ot">-&gt;</span> throw <span class="op">$</span> <span class="dt">Excepting.ValueMaltyped</span> e <span class="dt">BoolType</span> v</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Return</span> e <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;execute return: %s&quot;</span> (<span class="fu">show</span> inst_)</span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> <span class="op">&lt;$&gt;</span> evaluateExpression e</span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ProcedureCall</span> f args <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;execute procedure call: %s&quot;</span> (<span class="fu">show</span> inst_)</span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>    queryFunction f <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- closure</span></span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Left</span> ((xs, inst), scp) <span class="ot">-&gt;</span> withLocalScope <span class="kw">do</span></span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- evaluate arguments in local scope</span></span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>        <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;evaluate arguments: %s&quot;</span> (<span class="fu">show</span> args)</span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a>        vs <span class="ot">&lt;-</span> <span class="fu">mapM</span> evaluateExpression args</span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- init param vars in local scope (will be GC&#39;ed by `withLocalScope`)</span></span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a>        <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;initialize paramater variables: %s&quot;</span> (<span class="fu">show</span> xs)</span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mapM_</span> (<span class="fu">uncurry</span> initializeVariable) (<span class="fu">zip</span> xs vs)</span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">--</span></span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a>        <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;enter function scope&quot;</span></span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a>        withScope scp <span class="kw">do</span></span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a>          <span class="co">-- execute instruction in function scope</span></span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a>          <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;execute closure instruction in function scope&quot;</span></span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a>          void <span class="op">$</span> executeInstruction inst</span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- primitive function</span></span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Right</span> pf <span class="ot">-&gt;</span> withLocalScope <span class="kw">do</span></span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- evaluate arguments in outer scope</span></span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a>        vs <span class="ot">&lt;-</span> <span class="fu">mapM</span> evaluateExpression args</span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- execute primitive function</span></span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a>        void <span class="op">$</span> executePrimitiveFunction pf vs</span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- ignore result</span></span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Pass</span> <span class="ot">-&gt;</span></span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a><span class="ot">executePrimitiveFunction ::</span> <span class="dt">Name</span> <span class="ot">-&gt;</span> [<span class="dt">Expression</span>] <span class="ot">-&gt;</span> <span class="dt">Execution</span> r (<span class="dt">Maybe</span> <span class="dt">Value</span>)</span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a>executePrimitiveFunction f args <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;execute primitive function: %s(%s)&quot;</span> (<span class="fu">show</span> f) (showArgs args)</span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> (f, args) <span class="kw">of</span></span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- bool</span></span>
<span id="cb35-90"><a href="#cb35-90" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;~&quot;</span>, [<span class="dt">Bool</span> p]) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">Bool</span> (<span class="fu">not</span> p)</span>
<span id="cb35-91"><a href="#cb35-91" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;&amp;&amp;&quot;</span>, [<span class="dt">Bool</span> p, <span class="dt">Bool</span> q]) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">Bool</span> (p <span class="op">&amp;&amp;</span> q)</span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;||&quot;</span>, [<span class="dt">Bool</span> p, <span class="dt">Bool</span> q]) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">Bool</span> (p <span class="op">||</span> q)</span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;show_bool&quot;</span>, [b]) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">String</span> (<span class="fu">show</span> b)</span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- int</span></span>
<span id="cb35-95"><a href="#cb35-95" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;+&quot;</span>, [<span class="dt">Int</span> x, <span class="dt">Int</span> y]) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">Int</span> (x <span class="op">+</span> y)</span>
<span id="cb35-96"><a href="#cb35-96" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;-&quot;</span>, [<span class="dt">Int</span> x, <span class="dt">Int</span> y]) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">Int</span> (x <span class="op">-</span> y)</span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;*&quot;</span>, [<span class="dt">Int</span> x, <span class="dt">Int</span> y]) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">Int</span> (x <span class="op">*</span> y)</span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;/&quot;</span>, [<span class="dt">Int</span> x, <span class="dt">Int</span> y]) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">Int</span> (x <span class="ot">`div`</span> y)</span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;^&quot;</span>, [<span class="dt">Int</span> x, <span class="dt">Int</span> y]) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">Int</span> (x <span class="op">^</span> y)</span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;%&quot;</span>, [<span class="dt">Int</span> x, <span class="dt">Int</span> y]) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">Int</span> (x <span class="ot">`mod`</span> y)</span>
<span id="cb35-101"><a href="#cb35-101" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;=&quot;</span>, [<span class="dt">Int</span> x, <span class="dt">Int</span> y]) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">Bool</span> (x <span class="op">==</span> y)</span>
<span id="cb35-102"><a href="#cb35-102" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;&gt;&quot;</span>, [<span class="dt">Int</span> x, <span class="dt">Int</span> y]) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">Bool</span> (x <span class="op">&gt;</span> y)</span>
<span id="cb35-103"><a href="#cb35-103" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;&gt;=&quot;</span>, [<span class="dt">Int</span> x, <span class="dt">Int</span> y]) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">Bool</span> (x <span class="op">&gt;=</span> y)</span>
<span id="cb35-104"><a href="#cb35-104" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;&lt;&quot;</span>, [<span class="dt">Int</span> x, <span class="dt">Int</span> y]) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">Bool</span> (x <span class="op">&lt;</span> y)</span>
<span id="cb35-105"><a href="#cb35-105" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;&lt;=&quot;</span>, [<span class="dt">Int</span> x, <span class="dt">Int</span> y]) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">Bool</span> (x <span class="op">&lt;=</span> y)</span>
<span id="cb35-106"><a href="#cb35-106" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;show_int&quot;</span>, [i]) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">String</span> (<span class="fu">show</span> i)</span>
<span id="cb35-107"><a href="#cb35-107" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- string</span></span>
<span id="cb35-108"><a href="#cb35-108" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;&lt;&gt;&quot;</span>, [<span class="dt">String</span> a, <span class="dt">String</span> b]) <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">String</span> (a <span class="op">&lt;&gt;</span> b)</span>
<span id="cb35-109"><a href="#cb35-109" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;write&quot;</span>, [<span class="dt">String</span> a]) <span class="ot">-&gt;</span> writeOutput a <span class="op">&gt;&gt;</span> <span class="fu">return</span> <span class="dt">Nothing</span></span>
<span id="cb35-110"><a href="#cb35-110" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Name</span> <span class="st">&quot;read&quot;</span>, []) <span class="ot">-&gt;</span></span>
<span id="cb35-111"><a href="#cb35-111" aria-hidden="true" tabindex="-1"></a>      readNextInput <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb35-112"><a href="#cb35-112" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Just</span> s <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">.</span> <span class="dt">Just</span> <span class="op">$</span> <span class="dt">String</span> s</span>
<span id="cb35-113"><a href="#cb35-113" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> throw <span class="dt">Excepting.EndOfInput</span></span>
<span id="cb35-114"><a href="#cb35-114" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- uninterpreted</span></span>
<span id="cb35-115"><a href="#cb35-115" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">-&gt;</span></span>
<span id="cb35-116"><a href="#cb35-116" aria-hidden="true" tabindex="-1"></a>      throw <span class="op">$</span> <span class="dt">Excepting.UninterpretedPrimitiveFunction</span> f args</span></code></pre></div>
<p>Note that <code>executePrimitiveFunction</code> is hard-coded to
execute all the functions specified in the <code>Primitive</code>
module. This is not an ideal organization, since it requires the
maintainance of two different locations to match each other. This is
error-prone, but for this casual project it is satisfactory.
Additionally, many other changes to the primitives system are required
to make it well-organized at all. The primitives system is really kind
of ad-hoc in this implementation of Impe.</p>
<p>Next, a definition of <em>evaluation</em> is needed. The difference
between execution and evaluation is that execution does not have any
results, whereas evaluation yields a result i.e. a value. Most
instructions do not evaluate to anything, so the
<code>evaluateInstruction</code> function makes sure that any time an
instruction is expected to evaluate to something and it doesn't
actually, there's an error. However, if typechecking is correct then
this should never happen in practice.</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="ot">evaluateInstruction ::</span> <span class="dt">Instruction</span> <span class="ot">-&gt;</span> <span class="dt">Execution</span> r <span class="dt">Value</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>evaluateInstruction inst <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;evaluate instruction: %s&quot;</span> (<span class="fu">show</span> inst)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  executeInstruction inst <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> v <span class="ot">-&gt;</span> <span class="fu">return</span> v</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> throw <span class="op">$</span> <span class="dt">Excepting.InstructionNoReturn</span> inst</span></code></pre></div>
<p>Finally, evaluating an expression is very simple. Most kinds of
expressions are already values, all of them except for variables and
function applications. Variables are not values since they can be
dereferenced. Function applications are not values since they can be
reduced by calling the functions on the given arguments and returning
the result.</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="ot">evaluateExpression ::</span> <span class="dt">Expression</span> <span class="ot">-&gt;</span> <span class="dt">Execution</span> r <span class="dt">Value</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>evaluateExpression e_ <span class="ot">=</span> <span class="kw">case</span> e_ <span class="kw">of</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Variable</span> x <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;evaluate variable: %s&quot;</span> (<span class="fu">show</span> e_)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    queryVariable x</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Application</span> f args <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;evaluate application: %s&quot;</span> (<span class="fu">show</span> e_)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    queryFunction f <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- constructed function</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Left</span> ((xs, inst), scp) <span class="ot">-&gt;</span> withLocalScope <span class="kw">do</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- evaluate arguments in local scope</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>        vs <span class="ot">&lt;-</span> <span class="fu">mapM</span> evaluateExpression args</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- init param vars in local scope (will be GC&#39;ed by `withLocalScope`)</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mapM_</span> (<span class="fu">uncurry</span> initializeVariable) (<span class="fu">zip</span> xs vs)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>        withScope scp <span class="kw">do</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>          <span class="co">-- declare argument bindings in inner scope</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mapM_</span> (<span class="fu">uncurry</span> adjustVariable) (<span class="fu">zip</span> xs vs)</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>          <span class="co">-- evaluate instruction, returning result</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>          evaluateInstruction inst</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- primitive function</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Right</span> pf <span class="ot">-&gt;</span> withLocalScope <span class="kw">do</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- evaluate arguments in outer scope</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>        args&#39; <span class="ot">&lt;-</span> <span class="fu">mapM</span> evaluateExpression args</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- hand-off to execute primitive function</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>        executePrimitiveFunction pf args&#39; <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Just</span> v <span class="ot">-&gt;</span> <span class="fu">return</span> v</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Nothing</span> <span class="ot">-&gt;</span> throw <span class="op">$</span> <span class="dt">Excepting.ExpressionNoValue</span> e_</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>  v <span class="ot">-&gt;</span> <span class="fu">return</span> v</span></code></pre></div>
<p>Throughout these functions, a few helper functions for interfacing
with the context have gone undefined. The are straightforward to
implement from the <code>get</code>, <code>modify</code>, and the
<code>At</code> instance of <code>Namespace</code>. Additionally,
functions like <code>queryVariable</code> and <code>queryFunction</code>
throw exceptions when the queried name is not in the namespace (which
should never happen in practice if typechecking is correct). See the
source code for the details on these functions.</p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="ot">queryVariable ::</span> <span class="dt">Name</span> <span class="ot">-&gt;</span> <span class="dt">Execution</span> r <span class="dt">Value</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>queryVariable x <span class="ot">=</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  gets (<span class="op">^.</span> namespace <span class="op">.</span> at x) <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> (<span class="dt">EntryValue</span> (<span class="dt">Just</span> val)) <span class="ot">-&gt;</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span> val</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> (<span class="dt">EntryValue</span> <span class="dt">Nothing</span>) <span class="ot">-&gt;</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>      throw <span class="op">$</span> <span class="dt">Excepting.VariableUninitializedMention</span> x</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> (<span class="dt">EntryClosure</span> _) <span class="ot">-&gt;</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>      throw <span class="op">$</span> <span class="dt">Excepting.VariableNo</span> x</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> <span class="dt">EntryPrimitiveFunction</span> <span class="ot">-&gt;</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>      throw <span class="op">$</span> <span class="dt">Excepting.VariableNo</span> x</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>      throw <span class="op">$</span> <span class="dt">Excepting.VariableUndeclaredMention</span> x</span></code></pre></div>
<h3 id="interpreting">§ <a href="#interpreting"
class="no-link-favicon no-link-preview">Interpreting</a></h3>
<p>Now to combine it all together! To <em>interpret</em> a program is,
following the three steps outlined in <span><span
class="sidenote preview">Interpetation<br/><em><a href="#interpretation"
title="_blank"><img src="/favicon.ico" class="favicon"
alt="/favicon.ico" />rybl.net</a></em><br/>TODO:
baseDescription</span><a href="#interpretation"><img src="/favicon.ico"
class="favicon" alt="/favicon.ico" />Interpetation</a></span>, to pass
the results from each step to the next, all inside of an effect monad
that handles logging and exceptions. Even more, polysemy makes it each
to include different state effects, so the interpretation effect can
include the state effects from typechecking and execution as well -- all
in the <code>Interpretation</code> monad:</p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Interpretation</span> r a <span class="ot">=</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  ( <span class="dt">Member</span> (<span class="dt">Output</span> <span class="dt">Log</span>) r,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Typechecking.Context</span>) r,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Executing.Context</span>) r,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">Error</span> <span class="dt">Exception</span>) r</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">=&gt;</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Sem</span> r a</span></code></pre></div>
<p>Decorated with loggs and the relevant type annotations:</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="ot">interpretProgram ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Interpretation</span> r ()</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>interpretProgram filename source <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- parse</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> <span class="st">&quot;parsing source&quot;</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  prgm <span class="ot">&lt;-</span> parseProgram filename source</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;parsed program:\n\n%s\n&quot;</span> (<span class="fu">show</span> prgm)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- typecheck</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> <span class="st">&quot;typechecking program&quot;</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  Typechecking.typecheckProgram prgm</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  tchCtx <span class="ot">&lt;- get ::</span> <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Typechecking.Context</span>) r <span class="ot">=&gt;</span> <span class="dt">Sem</span> r <span class="dt">Typechecking.Context</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;typechecked context:\n\n%s\n&quot;</span> (<span class="fu">show</span> tchCtx)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- execute</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;executing program&quot;</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>  Executing.executeProgram prgm</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>  exeCtx <span class="ot">&lt;- get ::</span> <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Executing.Context</span>) r <span class="ot">=&gt;</span> <span class="dt">Sem</span> r <span class="dt">Executing.Context</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;executed context:\n\n%s\n&quot;</span> (<span class="fu">show</span> exeCtx)</span></code></pre></div>
<p>The function <code>interpretProgram</code> takes a source file,
parses its program, typechecks that program, and executes the type-safe
program. If there are any exceptions along the way, the flow is escaped
with the relevant exception in tact.</p>
<p>The core library for <code>impe</code> is now complete.</p>
<p>Now all is needed is a way to handle an
<code>Interpretation</code>.</p>
<h3 id="main">§ <a href="#main"
class="no-link-favicon no-link-preview">Main</a></h3>
<p>The executable program that runs Impe.</p>
<p>Modules <code>Main</code>, <code>Main.Output</code>, and
<code>Main.Excepting</code>.</p>
<p>The package <code>impe</code> comes with a library that defines all
the internals of the Impe language, and an executable for interpreting
Impe programs according to Impe's definition. So far the executable has
two functionalities:</p>
<ol>
<li>interpret an Impe source file</li>
<li>facilitate an Impe interactive REPL</li>
</ol>
<p>To organize this executable and some options about how to interpret
Impe programs, some command line options will be useful.</p>
<h4 id="command-line-options">§ <a href="#command-line-options"
class="no-link-favicon no-link-preview">Command Line Options</a></h4>
<p>Modules <code>Main.Config.Grammar</code>and
<code>Main.Config.Parsing</code>. Using
<code>options-applicative</code>.</p>
<p>The <code>options-applicative</code> library offers a convenient way
to define a parser for command line options. A configuration for running
the executable is a record as follows:</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Config</span> <span class="ot">=</span> <span class="dt">Config</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  {<span class="ot"> mode ::</span> <span class="dt">Mode</span>,</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="ot">    verbosity ::</span> <span class="dt">Verbosity</span>,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="ot">    source_filename ::</span> <span class="dt">Maybe</span> <span class="dt">String</span>,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="ot">    input_filename ::</span> <span class="dt">Maybe</span> <span class="dt">String</span>,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="ot">    output_filename ::</span> <span class="dt">Maybe</span> <span class="dt">String</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>The parser takes a form very similar to a <code>parsec</code> parser,
but <code>options-applicative</code> implicitly includes features for
handling command line arguments such as optional arguments, flags, and
"help" message annotations.</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="ot">config ::</span> <span class="dt">ParserInfo</span> <span class="dt">Grammar.Config</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>config <span class="ot">=</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  info</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    ( helper</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;*&gt;</span> version</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;*&gt;</span> ( <span class="dt">Grammar.Config</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>                <span class="op">&lt;$&gt;</span> mode</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>                <span class="op">&lt;*&gt;</span> verbosity</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>                <span class="op">&lt;*&gt;</span> source_filename</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>                <span class="op">&lt;*&gt;</span> input_filename</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>                <span class="op">&lt;*&gt;</span> output_filename</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    (fullDesc <span class="op">&lt;&gt;</span> progDesc <span class="st">&quot;impe&quot;</span> <span class="op">&lt;&gt;</span> header <span class="st">&quot;the impe language&quot;</span>)</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a><span class="ot">mode ::</span> <span class="dt">Parser</span> <span class="dt">Grammar.Mode</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>mode <span class="ot">=</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>  flag</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Grammar.Mode_Interpret</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Grammar.Mode_Interact</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>    (short <span class="ch">&#39;i&#39;</span> <span class="op">&lt;&gt;</span> long <span class="st">&quot;interactive&quot;</span> <span class="op">&lt;&gt;</span> help <span class="st">&quot;interactive REPL&quot;</span>)</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a><span class="ot">version ::</span> <span class="dt">Parser</span> (a <span class="ot">-&gt;</span> a)</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>version <span class="ot">=</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>  infoOption</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">unwords</span> [showVersion Paths_impe.version, <span class="op">$</span>(gitHash)])</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>    (long <span class="st">&quot;version&quot;</span> <span class="op">&lt;&gt;</span> help <span class="st">&quot;show version&quot;</span>)</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a><span class="ot">verbosity ::</span> <span class="dt">Parser</span> <span class="dt">Grammar.Verbosity</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>verbosity <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>  option</span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>    parseVerbosity</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>    ( metavar <span class="st">&quot;VERBOSITY&quot;</span></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;&gt;</span> short <span class="ch">&#39;v&#39;</span></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;&gt;</span> long <span class="st">&quot;verbosity&quot;</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;&gt;</span> value (Grammar.verbosities <span class="op">!</span> <span class="st">&quot;normal&quot;</span>)</span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;&gt;</span> help <span class="st">&quot;verbosity modes: debug, normal, quiet, silent, arrogant&quot;</span></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a><span class="ot">parseVerbosity ::</span> <span class="dt">ReadM</span> <span class="dt">Grammar.Verbosity</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>parseVerbosity <span class="ot">=</span></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>  eitherReader <span class="op">$</span></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>    ( \s <span class="ot">-&gt;</span></span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">case</span> Grammar.verbosities <span class="op">!?</span> s <span class="kw">of</span></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Just</span> vrb <span class="ot">-&gt;</span> <span class="fu">return</span> vrb</span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Left</span> <span class="op">$</span> printf <span class="st">&quot;Unrecognized verbosity `%s&#39;&quot;</span> s</span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span> Prelude.filter (<span class="fu">not</span> <span class="op">.</span> <span class="dt">Char</span><span class="op">.</span><span class="fu">isSpace</span>)</span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a><span class="ot">source_filename ::</span> <span class="dt">Parser</span> (<span class="dt">Maybe</span> <span class="dt">String</span>)</span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a>source_filename <span class="ot">=</span></span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Just</span></span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;$&gt;</span> ( strArgument</span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a>            ( metavar <span class="st">&quot;SOURCE&quot;</span></span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a>                <span class="op">&lt;&gt;</span> help <span class="st">&quot;source filename&quot;</span></span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;|&gt;</span> <span class="fu">pure</span> <span class="dt">Nothing</span></span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a><span class="ot">input_filename ::</span> <span class="dt">Parser</span> (<span class="dt">Maybe</span> <span class="dt">String</span>)</span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a>input_filename <span class="ot">=</span></span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Just</span></span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;$&gt;</span> strOption</span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a>      ( metavar <span class="st">&quot;INPUT&quot;</span></span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;&gt;</span> long <span class="st">&quot;in&quot;</span></span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;&gt;</span> help <span class="st">&quot;input data filename&quot;</span></span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;|&gt;</span> <span class="fu">pure</span> <span class="dt">Nothing</span></span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true" tabindex="-1"></a><span class="ot">output_filename ::</span> <span class="dt">Parser</span> (<span class="dt">Maybe</span> <span class="dt">String</span>)</span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true" tabindex="-1"></a>output_filename <span class="ot">=</span></span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Just</span></span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;$&gt;</span> strOption</span>
<span id="cb42-74"><a href="#cb42-74" aria-hidden="true" tabindex="-1"></a>      ( metavar <span class="st">&quot;OUTPUT&quot;</span></span>
<span id="cb42-75"><a href="#cb42-75" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;&gt;</span> long <span class="st">&quot;out&quot;</span></span>
<span id="cb42-76"><a href="#cb42-76" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;&gt;</span> help <span class="st">&quot;output data filename&quot;</span></span>
<span id="cb42-77"><a href="#cb42-77" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb42-78"><a href="#cb42-78" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;|&gt;</span> <span class="fu">pure</span> <span class="dt">Nothing</span></span></code></pre></div>
<p>The basic way to read the above definitions is that there are a
selection of basic <code>Parser</code> constructions:</p>
<ul>
<li><code>strArgument</code> -- a string-valued argument</li>
<li><code>info</code> -- prints out a message</li>
<li><code>flag</code> -- optional</li>
<li><code>option</code>, <code>strOption</code> -- optional with an
argument</li>
</ul>
<p>These constructors take a few relevant arguments and one last big
argument composed by a bunch of <code>&lt;&gt;</code>'ed together
pieces. This argument is the <em>modifier</em>, and its components are
<em>fields</em>. <code>options-applicative</code> implicitly assigns a
variety of default values that are overriden when a specific field is
<code>&lt;&gt;</code>'ed on the modifier.</p>
<p>Then the <code>config</code> parser's functionality can be lifted
into an open polysemy effect monad to be used in <code>Main</code> as
follows:</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="ot">parseConfig ::</span> <span class="dt">Member</span> (<span class="dt">Embed</span> <span class="dt">IO</span>) r <span class="ot">=&gt;</span> <span class="dt">Sem</span> r <span class="dt">Grammar.Config</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>parseConfig <span class="ot">=</span> embed <span class="op">$</span> execParser config</span></code></pre></div>
<h4 id="interactive-repl">§ <a href="#interactive-repl"
class="no-link-favicon no-link-preview">Interactive REPL</a></h4>
<p>Modules <code>Main.Interacting</code>,
<code>Main.Interacting.Grammar</code>,
<code>Main.Interacting.Lexing</code>,
<code>Main.Interacting.Parsing</code>.</p>
<p>Using Polysemy-organized effects.</p>
<p>This interactive REPL turned out to be much more annoying to
implement that originally antifipated. But it works.</p>
<p>The basic idea of a REPL -- a read-evaluate-print loop -- is to allow
the user to, repeatedly, type in an expression and then print out the
evaluated result (if the expression has one). Since Impe has statements
as well as expressions, either can be used in the REPL. Additionally the
REPL provides a few metacommands for the sake of being user- and
debugging-friendly, such as printing the context, printing a help
message, and quiting the REPL.</p>
<p>Here is a little grammar for REPL expressions, where
<code>Instruction</code> and <code>Expression</code> come from
<code>Language.Impe.Grammar</code>.</p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Command</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">Command_Instruction</span> <span class="dt">Instruction</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Command_Expression</span> <span class="dt">Expression</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">Command_MetaCommand</span> <span class="dt">MetaCommand</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">MetaCommand</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">MetaCommand_Context</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">MetaCommand_Quit</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">MetaCommand_Help</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>)</span></code></pre></div>
<p>The details are omitted, but a simple parsec parser can be derived
for this language, where:</p>
<ul>
<li>an instruction is input as "<instruction>"</li>
<li>an expression is input as ":e <expression>" or ":eval
<expression>"</li>
<li>a metacommand is input as ":<metacommand>"</li>
</ul>
<p>Finally, the REPL itself is implemented in a slightly convoluted way,
which takes advantage of polysemy.</p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">interact</span> <span class="ot">::</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  ( <span class="dt">Member</span> (<span class="dt">Output</span> <span class="dt">Log</span>) r,</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Typechecking.Context</span>) r,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Executing.Context</span>) r,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">Error</span> <span class="dt">MainExcepting.Exception</span>) r,</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">Reader</span> <span class="dt">Config</span>) r,</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">Embed</span> <span class="dt">IO</span>) r</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">=&gt;</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Sem</span> r ()</span></code></pre></div>
<p>Since the type of <code>interact</code> is defined as an open effect
monad, <code>interact</code> can be trivially embedded in the
<code>main</code> program earlier without the need for special
lifting.</p>
<p>Back to interacting, the situation is that interpreting can have
side-effects, such as logging and excepting, which need to be dealt with
in the REPL. Interpretation excepting should not exit the REPL, so it
needs to be caught and then somehow projected to the user while not
escaping the REPLoop. Logging is handled according to the
<em>verbosity</em> configuration given by the command line
arguments.</p>
<p>So, there is an <code>interact</code> function which checks each REPL
loop by making sure that the loop should continue (i.e. that the user
has not quit yes), handles any exceptions that arise from interpreting,
and prints any output yielded from execution. The
<code>interactStep</code> function does the actual work of interaction
with the user, exposing the effects of logging (output) and excepting
that are handled by <code>interact</code>.</p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode hs"><code class="sourceCode haskell"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">interact</span> <span class="ot">::</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  ( <span class="dt">Member</span> (<span class="dt">Output</span> <span class="dt">Log</span>) r,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Typechecking.Context</span>) r,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Executing.Context</span>) r,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">Error</span> <span class="dt">MainExcepting.Exception</span>) r,</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">Reader</span> <span class="dt">Config</span>) r,</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">Embed</span> <span class="dt">IO</span>) r</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">=&gt;</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Sem</span> r ()</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="fu">interact</span> <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  continue <span class="ot">&lt;-</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    (runWriter <span class="op">.</span><span class="ot"> runError ::</span> <span class="dt">Sem</span> (<span class="dt">Error</span> <span class="dt">ImpeExcepting.Exception</span> <span class="op">:</span> <span class="dt">Writer</span> <span class="dt">String</span> <span class="op">:</span> r) <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">Sem</span> r (<span class="dt">String</span>, <span class="dt">Either</span> <span class="dt">ImpeExcepting.Exception</span> <span class="dt">Bool</span>)) interactStep <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>      (out, <span class="dt">Left</span> err) <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- write to output</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>        writeOutputAppended out</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- log output error</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">log</span> <span class="dt">Tag_Output</span> <span class="op">$</span> <span class="fu">show</span> err</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- continue</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span> <span class="dt">True</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>      (out, <span class="dt">Right</span> b) <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- write to output</span></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>        writeOutputAppended out</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- continue?</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span> b</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> continue</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">then</span> <span class="fu">interact</span></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span> <span class="fu">log</span> <span class="dt">Tag_Output</span> <span class="st">&quot;[impe - interact] quit&quot;</span></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a><span class="ot">interactStep ::</span></span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>  ( <span class="dt">Member</span> (<span class="dt">Output</span> <span class="dt">Log</span>) r,</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Typechecking.Context</span>) r,</span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Executing.Context</span>) r,</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">Error</span> <span class="dt">ImpeExcepting.Exception</span>) r,</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">Error</span> <span class="dt">MainExcepting.Exception</span>) r,</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">Writer</span> <span class="dt">String</span>) r,</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">Embed</span> <span class="dt">IO</span>) r</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">=&gt;</span></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Sem</span> r <span class="dt">Bool</span></span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>interactStep <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- prompt</span></span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>  embed <span class="kw">do</span></span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">putStr</span> <span class="st">&quot;&gt; &quot;</span></span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>    hFlush stdout</span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>  src <span class="ot">&lt;-</span> embed <span class="fu">getLine</span></span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- parse command</span></span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> <span class="st">&quot;parsing command&quot;</span></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>  cmd <span class="ot">&lt;-</span> parseCommand src</span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log</span> <span class="dt">Tag_Debug</span> <span class="op">$</span> printf <span class="st">&quot;parsed command: %s&quot;</span> (<span class="fu">show</span> cmd)</span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- handle command</span></span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">&lt;-</span></span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>    parseCommand src <span class="op">&gt;&gt;=</span> \<span class="kw">case</span></span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Command_Instruction</span> inst <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- interpret input</span></span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a>        (mb_v, t) <span class="ot">&lt;-</span> interpretInstructionParsed inst</span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- handle outputs</span></span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a>        Executing.tellOutputString</span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a>        Executing.resetOutputString</span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- result</span></span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a>        <span class="kw">case</span> mb_v <span class="kw">of</span></span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Just</span> v <span class="ot">-&gt;</span> <span class="fu">log</span> <span class="dt">Tag_Output</span> <span class="op">$</span> printf <span class="st">&quot;returns %s :: %s\n&quot;</span> (<span class="fu">show</span> v) (<span class="fu">show</span> t)</span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a>          <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">return</span> ()</span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- continue</span></span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span> <span class="dt">True</span></span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Command_Expression</span> expr <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb46-65"><a href="#cb46-65" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- interpret input</span></span>
<span id="cb46-66"><a href="#cb46-66" aria-hidden="true" tabindex="-1"></a>        (v, t) <span class="ot">&lt;-</span> interpretExpressionParsed expr</span>
<span id="cb46-67"><a href="#cb46-67" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- handle outputs</span></span>
<span id="cb46-68"><a href="#cb46-68" aria-hidden="true" tabindex="-1"></a>        Executing.tellOutputString</span>
<span id="cb46-69"><a href="#cb46-69" aria-hidden="true" tabindex="-1"></a>        Executing.resetOutputString</span>
<span id="cb46-70"><a href="#cb46-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- result</span></span>
<span id="cb46-71"><a href="#cb46-71" aria-hidden="true" tabindex="-1"></a>        <span class="fu">log</span> <span class="dt">Tag_Output</span> <span class="op">$</span> printf <span class="st">&quot;%s :: %s\n&quot;</span> (<span class="fu">show</span> v) (<span class="fu">show</span> t)</span>
<span id="cb46-72"><a href="#cb46-72" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- continue</span></span>
<span id="cb46-73"><a href="#cb46-73" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span> <span class="dt">True</span></span>
<span id="cb46-74"><a href="#cb46-74" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Command_MetaCommand</span> mtacmd <span class="ot">-&gt;</span> interpretMetaCommand mtacmd</span>
<span id="cb46-75"><a href="#cb46-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> b</span>
<span id="cb46-76"><a href="#cb46-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-77"><a href="#cb46-77" aria-hidden="true" tabindex="-1"></a><span class="ot">interpretMetaCommand ::</span></span>
<span id="cb46-78"><a href="#cb46-78" aria-hidden="true" tabindex="-1"></a>  ( <span class="dt">Member</span> (<span class="dt">Output</span> <span class="dt">Log</span>) r,</span>
<span id="cb46-79"><a href="#cb46-79" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Typechecking.Context</span>) r,</span>
<span id="cb46-80"><a href="#cb46-80" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Executing.Context</span>) r,</span>
<span id="cb46-81"><a href="#cb46-81" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">Error</span> <span class="dt">ImpeExcepting.Exception</span>) r,</span>
<span id="cb46-82"><a href="#cb46-82" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">Error</span> <span class="dt">MainExcepting.Exception</span>) r,</span>
<span id="cb46-83"><a href="#cb46-83" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Member</span> (<span class="dt">Embed</span> <span class="dt">IO</span>) r</span>
<span id="cb46-84"><a href="#cb46-84" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">=&gt;</span></span>
<span id="cb46-85"><a href="#cb46-85" aria-hidden="true" tabindex="-1"></a>  <span class="dt">MetaCommand</span> <span class="ot">-&gt;</span></span>
<span id="cb46-86"><a href="#cb46-86" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Sem</span> r <span class="dt">Bool</span></span>
<span id="cb46-87"><a href="#cb46-87" aria-hidden="true" tabindex="-1"></a>interpretMetaCommand <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb46-88"><a href="#cb46-88" aria-hidden="true" tabindex="-1"></a>  <span class="dt">MetaCommand_Context</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb46-89"><a href="#cb46-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- log contexts</span></span>
<span id="cb46-90"><a href="#cb46-90" aria-hidden="true" tabindex="-1"></a>    tchCtx <span class="ot">&lt;- get ::</span> <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Typechecking.Context</span>) r <span class="ot">=&gt;</span> <span class="dt">Sem</span> r <span class="dt">Typechecking.Context</span></span>
<span id="cb46-91"><a href="#cb46-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Output</span> <span class="op">$</span> printf <span class="st">&quot;typechecking context:\n\n%s\n&quot;</span> (<span class="fu">show</span> tchCtx)</span>
<span id="cb46-92"><a href="#cb46-92" aria-hidden="true" tabindex="-1"></a>    exeCtx <span class="ot">&lt;- get ::</span> <span class="dt">Member</span> (<span class="dt">State</span> <span class="dt">Executing.Context</span>) r <span class="ot">=&gt;</span> <span class="dt">Sem</span> r <span class="dt">Executing.Context</span></span>
<span id="cb46-93"><a href="#cb46-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Output</span> <span class="op">$</span> printf <span class="st">&quot;executing context:\n\n%s\n&quot;</span> (<span class="fu">show</span> exeCtx)</span>
<span id="cb46-94"><a href="#cb46-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- continue</span></span>
<span id="cb46-95"><a href="#cb46-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="dt">True</span></span>
<span id="cb46-96"><a href="#cb46-96" aria-hidden="true" tabindex="-1"></a>  <span class="dt">MetaCommand_Help</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb46-97"><a href="#cb46-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span> <span class="dt">Tag_Output</span> <span class="op">.</span> intercalate <span class="st">&quot;\n&quot;</span> <span class="op">$</span></span>
<span id="cb46-98"><a href="#cb46-98" aria-hidden="true" tabindex="-1"></a>      [ <span class="st">&quot;[impe - interact] help&quot;</span>,</span>
<span id="cb46-99"><a href="#cb46-99" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;  &lt;instruction&gt;      execute instruction&quot;</span>,</span>
<span id="cb46-100"><a href="#cb46-100" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;  :e &lt;expression&gt;    evaluate expression&quot;</span>,</span>
<span id="cb46-101"><a href="#cb46-101" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;  :context / :c      print context&quot;</span>,</span>
<span id="cb46-102"><a href="#cb46-102" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;  :help    / :h      print help&quot;</span>,</span>
<span id="cb46-103"><a href="#cb46-103" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;  :quit    / :q      quit&quot;</span></span>
<span id="cb46-104"><a href="#cb46-104" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb46-105"><a href="#cb46-105" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- continue</span></span>
<span id="cb46-106"><a href="#cb46-106" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="dt">True</span></span>
<span id="cb46-107"><a href="#cb46-107" aria-hidden="true" tabindex="-1"></a>  <span class="dt">MetaCommand_Quit</span> <span class="ot">-&gt;</span></span>
<span id="cb46-108"><a href="#cb46-108" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- quit</span></span>
<span id="cb46-109"><a href="#cb46-109" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> <span class="dt">False</span></span></code></pre></div>
<h2 id="conclusions">§ <a href="#conclusions"
class="no-link-favicon no-link-preview">Conclusions</a></h2>
<h2 id="references">§ <a href="#references"
class="no-link-favicon no-link-preview">References</a></h2>
<ul>
<li><a href="https://github.com/rybla/impe"
class="inReference no-link-preview"><img src="/favicon/github.com.svg"
class="favicon" alt="/favicon/github.com.svg" />riib/impe</a></li>
<li><a
href="https://hackage.haskell.org/package/polysemy-1.4.0.0/docs/Polysemy-Output.html"
class="inReference no-link-preview"><img src="/missing.ico"
class="favicon" alt="/missing.ico" />Polysemy.Output</a></li>
<li><a
href="https://hackage.haskell.org/package/polysemy-1.4.0.0/docs/Polysemy-Writer.html"
class="inReference no-link-preview"><img src="/missing.ico"
class="favicon" alt="/missing.ico" />Polysemy.Writer</a></li>
<li><a href="https://hackage.haskell.org/package/parsec"
class="inReference no-link-preview"><img src="/missing.ico"
class="favicon" alt="/missing.ico" />Parsec</a></li>
</ul>
<h2 id="signature">§ <a href="#signature"
class="no-link-favicon no-link-preview">Signature</a></h2>
<p>The following code block is the <a
href="https://en.wikipedia.org/wiki/EdDSA#Ed25519" title="_blank"><img
src="/favicon/wikipedia.org.ico" class="favicon"
alt="/favicon/wikipedia.org.ico" />Ed25519 signature</a> of this post's
<a href="/post_markdown/impe.md"><img src="/favicon.ico" class="favicon"
alt="/favicon.ico" />markdown content</a> encoded in base 64, using my
<em>secret key</em> and <a href="/key/main_ed25519.pub.txt"
title="_blank"><img src="/favicon.ico" class="favicon"
alt="/favicon.ico" />public key</a>.</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode txt"><code class="sourceCode default"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>5cb9bf2b422a7b1233c83f8a8f6c26a5968f92f37fc032ebe65c20309b8222ec31978005ed5688ddde768210ffa415f67d1b2969d9793bec71d970677f4c140f</span></code></pre></div>
<p>See <a href="/page/signature.html"><img src="/favicon.ico"
class="favicon" alt="/favicon.ico" />Signature</a> for more
information.</p></main>

    <footer>
      <div class="title">
        <div class="root-title">
          <a href="/">rybl.net</a>
        </div>

        <img class="website-icon" src="/image/rybl-small.png" />

        <div class="local-title">Impe</div>
      </div>
      <div class="menu">
        <div class="item">
          <a href="/">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"
              stroke-linecap="round" stroke-linejoin="round"
              class="lucide lucide-circle-slash-icon lucide-circle-slash">
              <circle cx="12" cy="12" r="10" />
              <line x1="9" x2="15" y1="15" y2="9" />
            </svg>
          </a>
        </div>
        <div class="item">
          <a href="/page/library.html">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"
              stroke-linecap="round" stroke-linejoin="round"
              class="icon lucide lucide-library-icon lucide-library">
              <path d="m16 6 4 14" />
              <path d="M12 6v14" />
              <path d="M8 8v12" />
              <path d="M4 4v16" />
            </svg>
          </a>
        </div>
        <div class="item">
          <a href="/page/about.html">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"
              stroke-linecap="round" stroke-linejoin="round"
              class="icon lucide lucide-info-icon lucide-info">
              <circle cx="12" cy="12" r="10" />
              <path d="M12 16v-4" />
              <path d="M12 8h.01" />
            </svg>
          </a>
        </div>
        <div class="item">
          <a href="/page/profile.html">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"
              stroke-linecap="round" stroke-linejoin="round"
              class="lucide lucide-globe-icon lucide-globe">
              <circle cx="12" cy="12" r="10" />
              <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20" />
              <path d="M2 12h20" />
            </svg>
          </a>
        </div>
        <div class="item">
          <a href="/page/references-graph.html">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"
              stroke-linecap="round" stroke-linejoin="round"
              class="lucide lucide-orbit-icon lucide-orbit">
              <path d="M20.341 6.484A10 10 0 0 1 10.266 21.85" />
              <path d="M3.659 17.516A10 10 0 0 1 13.74 2.152" />
              <circle cx="12" cy="12" r="3" />
              <circle cx="19" cy="5" r="2" />
              <circle cx="5" cy="19" r="2" />
            </svg>
          </a>
        </div>
        <div class="item">
          <a href="/page/signature.html"><svg xmlns="http://www.w3.org/2000/svg"
              width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="1" stroke-linecap="round"
              stroke-linejoin="round"
              class="lucide lucide-fingerprint-icon lucide-fingerprint">
              <path d="M12 10a2 2 0 0 0-2 2c0 1.02-.1 2.51-.26 4" />
              <path d="M14 13.12c0 2.38 0 6.38-1 8.88" />
              <path d="M17.29 21.02c.12-.6.43-2.3.5-3.02" />
              <path d="M2 12a10 10 0 0 1 18-6" />
              <path d="M2 16h.01" />
              <path d="M21.8 16c.2-2 .131-5.354 0-6" />
              <path d="M5 19.5C5.5 18 6 15 6 12a6 6 0 0 1 .34-2" />
              <path d="M8.65 22c.21-.66.45-1.32.57-2" />
              <path d="M9 6.8a6 6 0 0 1 9 5.2v2" />
            </svg></a>
        </div>
      </div></footer>  </body>
</html>
